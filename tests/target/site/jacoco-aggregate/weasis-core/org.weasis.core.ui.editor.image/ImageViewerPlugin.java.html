<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>ImageViewerPlugin.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Tests</a> &gt; <a href="../index.html" class="el_bundle">weasis-core</a> &gt; <a href="index.source.html" class="el_package">org.weasis.core.ui.editor.image</a> &gt; <span class="el_source">ImageViewerPlugin.java</span></div><h1>ImageViewerPlugin.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2009-2020 Weasis Team and other contributors.
 *
 * This program and the accompanying materials are made available under the terms of the Eclipse
 * Public License 2.0 which is available at https://www.eclipse.org/legal/epl-2.0, or the Apache
 * License, Version 2.0 which is available at https://www.apache.org/licenses/LICENSE-2.0.
 *
 * SPDX-License-Identifier: EPL-2.0 OR Apache-2.0
 */
package org.weasis.core.ui.editor.image;

import java.awt.BorderLayout;
import java.awt.Color;
import java.awt.Component;
import java.awt.Cursor;
import java.awt.Dialog;
import java.awt.Dialog.ModalityType;
import java.awt.Dimension;
import java.awt.Frame;
import java.awt.GridBagConstraints;
import java.awt.GridBagLayout;
import java.awt.Point;
import java.awt.Rectangle;
import java.awt.event.InputEvent;
import java.awt.event.MouseAdapter;
import java.awt.event.MouseEvent;
import java.awt.event.WindowAdapter;
import java.awt.event.WindowEvent;
import java.beans.PropertyChangeListener;
import java.lang.reflect.Constructor;
import java.util.ArrayList;
import java.util.Comparator;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Map.Entry;
import java.util.Objects;
import java.util.Optional;
import javax.swing.Icon;
import javax.swing.JComponent;
import javax.swing.JDialog;
import javax.swing.JPanel;
import javax.swing.plaf.PanelUI;
import org.weasis.core.Messages;
import org.weasis.core.api.explorer.model.DataExplorerModel;
import org.weasis.core.api.gui.util.ActionState;
import org.weasis.core.api.gui.util.ActionW;
import org.weasis.core.api.gui.util.ComboItemListener;
import org.weasis.core.api.gui.util.Filter;
import org.weasis.core.api.gui.util.GuiExecutor;
import org.weasis.core.api.gui.util.WinUtil;
import org.weasis.core.api.image.GridBagLayoutModel;
import org.weasis.core.api.image.LayoutConstraints;
import org.weasis.core.api.media.data.ImageElement;
import org.weasis.core.api.media.data.MediaSeries;
import org.weasis.core.api.media.data.Series;
import org.weasis.core.ui.editor.SeriesViewer;
import org.weasis.core.ui.editor.SeriesViewerEvent;
import org.weasis.core.ui.editor.SeriesViewerEvent.EVENT;
import org.weasis.core.ui.editor.SeriesViewerListener;
import org.weasis.core.ui.editor.ViewerPluginBuilder;
import org.weasis.core.ui.model.graphic.DragGraphic;
import org.weasis.core.ui.model.graphic.Graphic;
import org.weasis.core.ui.model.graphic.GraphicSelectionListener;
import org.weasis.core.ui.pref.Monitor;
import org.weasis.core.ui.util.MouseEventDouble;

public abstract class ImageViewerPlugin&lt;E extends ImageElement&gt; extends ViewerPlugin&lt;E&gt; {

<span class="nc" id="L70">  public static final String F_VIEWS = Messages.getString(&quot;ImageViewerPlugin.2&quot;);</span>

  // A model must have at least one view that inherited of DefaultView2d
<span class="nc" id="L73">  public static final Class&lt;?&gt; view2dClass = ViewCanvas.class;</span>
<span class="nc" id="L74">  public static final GridBagLayoutModel VIEWS_1x1 =</span>
      new GridBagLayoutModel(
          &quot;1x1&quot;, // NON-NLS
<span class="nc" id="L77">          String.format(Messages.getString(&quot;ImageViewerPlugin.1&quot;), &quot;1x1&quot;), // NON-NLS</span>
          1,
          1,
<span class="nc" id="L80">          view2dClass.getName());</span>
<span class="nc" id="L81">  public static final GridBagLayoutModel VIEWS_2x1 =</span>
      new GridBagLayoutModel(
          &quot;2x1&quot;, // NON-NLS
<span class="nc" id="L84">          String.format(F_VIEWS, &quot;2x1&quot;), // NON-NLS</span>
          2,
          1,
<span class="nc" id="L87">          view2dClass.getName());</span>
<span class="nc" id="L88">  public static final GridBagLayoutModel VIEWS_1x2 =</span>
      new GridBagLayoutModel(
          &quot;1x2&quot;, // NON-NLS
<span class="nc" id="L91">          String.format(F_VIEWS, &quot;1x2&quot;), // NON-NLS</span>
          1,
          2,
<span class="nc" id="L94">          view2dClass.getName());</span>
<span class="nc" id="L95">  public static final GridBagLayoutModel VIEWS_1x3 =</span>
      new GridBagLayoutModel(
          &quot;1x3&quot;, // NON-NLS
<span class="nc" id="L98">          String.format(F_VIEWS, &quot;1x3&quot;), // NON-NLS</span>
          1,
          3,
<span class="nc" id="L101">          view2dClass.getName());</span>
<span class="nc" id="L102">  public static final GridBagLayoutModel VIEWS_1x4 =</span>
      new GridBagLayoutModel(
          &quot;1x4&quot;, // NON-NLS
<span class="nc" id="L105">          String.format(F_VIEWS, &quot;1x4&quot;), // NON-NLS</span>
          1,
          4,
<span class="nc" id="L108">          view2dClass.getName());</span>
<span class="nc" id="L109">  public static final GridBagLayoutModel VIEWS_2x2_f2 =</span>
      new GridBagLayoutModel(
<span class="nc" id="L111">          ImageViewerPlugin.class.getResourceAsStream(&quot;/config/layoutModel2x2_f2.xml&quot;), // NON-NLS</span>
          &quot;layout_c2x1&quot;, // NON-NLS
<span class="nc" id="L113">          Messages.getString(&quot;ImageViewerPlugin.layout_c2x1&quot;));</span>
<span class="nc" id="L114">  public static final GridBagLayoutModel VIEWS_2_f1x2 =</span>
      new GridBagLayoutModel(
<span class="nc" id="L116">          ImageViewerPlugin.class.getResourceAsStream(&quot;/config/layoutModel2_f1x2.xml&quot;), // NON-NLS</span>
          &quot;layout_r1x2&quot;, // NON-NLS
<span class="nc" id="L118">          Messages.getString(&quot;ImageViewerPlugin.layout_c1x2&quot;));</span>
<span class="nc" id="L119">  public static final GridBagLayoutModel VIEWS_2x2 =</span>
      new GridBagLayoutModel(
          &quot;2x2&quot;, // NON-NLS
<span class="nc" id="L122">          String.format(F_VIEWS, &quot;2x2&quot;), // NON-NLS</span>
          2,
          2,
<span class="nc" id="L125">          view2dClass.getName());</span>
<span class="nc" id="L126">  public static final GridBagLayoutModel VIEWS_2x3 =</span>
      new GridBagLayoutModel(
          &quot;2x3&quot;, // NON-NLS
<span class="nc" id="L129">          String.format(F_VIEWS, &quot;2x3&quot;), // NON-NLS</span>
          2,
          3,
<span class="nc" id="L132">          view2dClass.getName());</span>
<span class="nc" id="L133">  public static final GridBagLayoutModel VIEWS_2x4 =</span>
      new GridBagLayoutModel(
          &quot;2x4&quot;, // NON-NLS
<span class="nc" id="L136">          String.format(F_VIEWS, &quot;2x4&quot;), // NON-NLS</span>
          2,
          4,
<span class="nc" id="L139">          view2dClass.getName());</span>

<span class="nc" id="L141">  public record LayoutModel(String uid, GridBagLayoutModel model) {}</span>

  /** The current focused &lt;code&gt;ImagePane&lt;/code&gt;. The default is 0. */
<span class="nc" id="L144">  protected ViewCanvas&lt;E&gt; selectedImagePane = null;</span>

  /** The array of display panes located in this image view panel. */
  protected final ArrayList&lt;ViewCanvas&lt;E&gt;&gt; view2ds;

  protected final ArrayList&lt;Component&gt; components;

<span class="nc" id="L151">  protected SynchView synchView = SynchView.NONE;</span>

  protected final ImageViewerEventManager&lt;E&gt; eventManager;
  protected final JPanel grid;
  protected GridBagLayoutModel layoutModel;

  protected ImageViewerPlugin(ImageViewerEventManager&lt;E&gt; eventManager, String pluginName) {
<span class="nc" id="L158">    this(eventManager, VIEWS_1x1, pluginName, null, null, null);</span>
<span class="nc" id="L159">  }</span>

  protected ImageViewerPlugin(
      ImageViewerEventManager&lt;E&gt; eventManager,
      GridBagLayoutModel layoutModel,
      String uid,
      String pluginName,
      Icon icon,
      String tooltips) {
<span class="nc" id="L168">    super(uid, pluginName, icon, tooltips);</span>
<span class="nc bnc" id="L169" title="All 2 branches missed.">    if (eventManager == null) {</span>
<span class="nc" id="L170">      throw new IllegalArgumentException(&quot;EventManager cannot be null&quot;);</span>
    }
<span class="nc" id="L172">    this.eventManager = eventManager;</span>
<span class="nc" id="L173">    view2ds = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L174">    components = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L175">    grid = new JPanel();</span>
    // For having a black background with any Look and Feel
<span class="nc" id="L177">    grid.setUI(new PanelUI() {});</span>
<span class="nc" id="L178">    grid.setBackground(Color.BLACK);</span>
<span class="nc" id="L179">    grid.setFocusCycleRoot(true);</span>
<span class="nc" id="L180">    grid.setLayout(new GridBagLayout());</span>
<span class="nc" id="L181">    add(grid, BorderLayout.CENTER);</span>

<span class="nc" id="L183">    setLayoutModel(layoutModel);</span>
<span class="nc" id="L184">    MouseHandler mouseHandler = new MouseHandler();</span>
<span class="nc" id="L185">    grid.addMouseListener(mouseHandler);</span>
<span class="nc" id="L186">    grid.addMouseMotionListener(mouseHandler);</span>
<span class="nc" id="L187">  }</span>

  /**
   * Returns true if type is instance of defaultClass. This operation is delegated in each bundle to
   * be sure all classes are visible.
   */
  public abstract boolean isViewType(Class&lt;?&gt; defaultClass, String type);

  public abstract int getViewTypeNumber(GridBagLayoutModel layout, Class&lt;?&gt; defaultClass);

  public abstract ViewCanvas&lt;E&gt; createDefaultView(String classType);

  public abstract Component createComponent(String clazz);

  public abstract Class&lt;?&gt; getSeriesViewerClass();

  public abstract GridBagLayoutModel getDefaultLayoutModel();

  public ViewCanvas&lt;E&gt; getSelectedImagePane() {
<span class="nc" id="L206">    return selectedImagePane;</span>
  }

  public List&lt;ViewCanvas&lt;E&gt;&gt; getView2ds() {
<span class="nc" id="L210">    return view2ds;</span>
  }

  public ImageViewerEventManager&lt;E&gt; getEventManager() {
<span class="nc" id="L214">    return eventManager;</span>
  }

  @Override
  public void close() {
<span class="nc" id="L219">    super.close();</span>

<span class="nc" id="L221">    GuiExecutor.execute(</span>
        () -&gt; {
<span class="nc" id="L223">          removeComponents();</span>
<span class="nc bnc" id="L224" title="All 2 branches missed.">          for (ViewCanvas v : view2ds) {</span>
<span class="nc" id="L225">            resetMaximizedSelectedImagePane(v);</span>
<span class="nc" id="L226">            v.disposeView();</span>
<span class="nc" id="L227">          }</span>
<span class="nc" id="L228">        });</span>
<span class="nc" id="L229">  }</span>

  /**
   * Get the layout of this panel.
   *
   * @return the layoutModel
   */
  public synchronized GridBagLayoutModel getLayoutModel() {
<span class="nc" id="L237">    return layoutModel;</span>
  }

  public GridBagLayoutModel getOriginalLayoutModel() {
    // Get the non clone layout from the list
<span class="nc" id="L242">    Optional&lt;ComboItemListener&lt;GridBagLayoutModel&gt;&gt; layout = eventManager.getAction(ActionW.LAYOUT);</span>
<span class="nc bnc" id="L243" title="All 2 branches missed.">    if (layout.isPresent()) {</span>
<span class="nc bnc" id="L244" title="All 2 branches missed.">      for (Object element : layout.get().getAllItem()) {</span>
<span class="nc bnc" id="L245" title="All 2 branches missed.">        if (element instanceof GridBagLayoutModel gbm) {</span>
<span class="nc bnc" id="L246" title="All 4 branches missed.">          if ((layoutModel.getIcon() != null &amp;&amp; gbm.getIcon() == layoutModel.getIcon())</span>
<span class="nc bnc" id="L247" title="All 2 branches missed.">              || layoutModel.toString().equals(gbm.toString())) {</span>
<span class="nc" id="L248">            return gbm;</span>
          }
        }
      }
    }
<span class="nc" id="L253">    return layoutModel;</span>
  }

  public static GridBagLayoutModel buildGridBagLayoutModel(int rows, int cols, String type) {
<span class="nc" id="L257">    StringBuilder buf = new StringBuilder();</span>
<span class="nc" id="L258">    buf.append(rows);</span>
<span class="nc" id="L259">    buf.append(&quot;x&quot;); // NON-NLS</span>
<span class="nc" id="L260">    buf.append(cols);</span>
<span class="nc" id="L261">    return new GridBagLayoutModel(</span>
<span class="nc" id="L262">        buf.toString(), String.format(ImageViewerPlugin.F_VIEWS, buf), rows, cols, type);</span>
  }

  public static void registerInDataExplorerModel(
      Map&lt;String, Object&gt; properties, PropertyChangeListener instance) {
<span class="nc bnc" id="L267" title="All 4 branches missed.">    if (properties != null &amp;&amp; instance != null) {</span>
<span class="nc" id="L268">      Object obj = properties.get(DataExplorerModel.class.getName());</span>
<span class="nc bnc" id="L269" title="All 2 branches missed.">      if (obj instanceof DataExplorerModel m) {</span>
        // Register the PropertyChangeListener
<span class="nc" id="L271">        m.addPropertyChangeListener(instance);</span>
      }
    }
<span class="nc" id="L274">  }</span>

  public static LayoutModel getLayoutModel(
      Map&lt;String, Object&gt; properties,
      GridBagLayoutModel defaultModel,
      ComboItemListener&lt;GridBagLayoutModel&gt; layoutAction) {
<span class="nc" id="L280">    GridBagLayoutModel model = defaultModel;</span>
<span class="nc" id="L281">    String uid = null;</span>
<span class="nc bnc" id="L282" title="All 2 branches missed.">    if (properties != null) {</span>
<span class="nc" id="L283">      Object obj = properties.get(GridBagLayoutModel.class.getName());</span>
<span class="nc bnc" id="L284" title="All 2 branches missed.">      if (obj instanceof GridBagLayoutModel gridBagLayoutModel) {</span>
<span class="nc" id="L285">        model = gridBagLayoutModel;</span>
      } else {
<span class="nc" id="L287">        obj = properties.get(ViewCanvas.class.getName());</span>
<span class="nc bnc" id="L288" title="All 4 branches missed.">        if (obj instanceof Integer intVal &amp;&amp; layoutAction != null) {</span>
<span class="nc" id="L289">          model = ImageViewerPlugin.getBestDefaultViewLayout(layoutAction, intVal, defaultModel);</span>
        }
      }

      // Set UID
<span class="nc" id="L294">      Object val = properties.get(ViewerPluginBuilder.UID);</span>
<span class="nc bnc" id="L295" title="All 2 branches missed.">      if (val instanceof String s) {</span>
<span class="nc" id="L296">        uid = s;</span>
      }
    }
<span class="nc" id="L299">    return new LayoutModel(uid, model);</span>
  }

  @Override
  public void addSeries(MediaSeries&lt;E&gt; sequence) {
<span class="nc bnc" id="L304" title="All 4 branches missed.">    if (sequence != null &amp;&amp; selectedImagePane != null) {</span>
<span class="nc bnc" id="L305" title="All 2 branches missed.">      if (SynchData.Mode.TILE.equals(synchView.getSynchData().getMode())) {</span>
<span class="nc" id="L306">        selectedImagePane.setSeries(sequence, null);</span>
<span class="nc" id="L307">        updateTileOffset();</span>
<span class="nc" id="L308">        return;</span>
      }
<span class="nc" id="L310">      ViewCanvas&lt;E&gt; viewPane = getSelectedImagePane();</span>
<span class="nc bnc" id="L311" title="All 2 branches missed.">      if (viewPane != null) {</span>
<span class="nc" id="L312">        viewPane.setSeries(sequence);</span>
<span class="nc" id="L313">        viewPane.getJComponent().repaint();</span>

        // Set selection to the next view
<span class="nc" id="L316">        setSelectedImagePane(getNextSelectedImagePane());</span>
      }
    }
<span class="nc" id="L319">  }</span>

  @Override
  public void removeSeries(MediaSeries&lt;E&gt; series) {
<span class="nc bnc" id="L323" title="All 2 branches missed.">    if (series != null) {</span>
<span class="nc bnc" id="L324" title="All 2 branches missed.">      for (ViewCanvas&lt;E&gt; v : view2ds) {</span>
<span class="nc bnc" id="L325" title="All 2 branches missed.">        if (v.getSeries() == series) {</span>
<span class="nc" id="L326">          v.setSeries(null, null);</span>
        }
<span class="nc" id="L328">      }</span>
    }
<span class="nc" id="L330">  }</span>

  public boolean closeIfNoContent() {
<span class="nc bnc" id="L333" title="All 2 branches missed.">    if (getOpenSeries().isEmpty()) {</span>
<span class="nc" id="L334">      close();</span>
<span class="nc" id="L335">      handleFocusAfterClosing();</span>
<span class="nc" id="L336">      return true;</span>
    }
<span class="nc" id="L338">    return false;</span>
  }

  @Override
  public List&lt;MediaSeries&lt;E&gt;&gt; getOpenSeries() {
<span class="nc" id="L343">    List&lt;MediaSeries&lt;E&gt;&gt; list = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L344" title="All 2 branches missed.">    for (ViewCanvas&lt;E&gt; v : view2ds) {</span>
<span class="nc" id="L345">      MediaSeries&lt;E&gt; s = v.getSeries();</span>
<span class="nc bnc" id="L346" title="All 2 branches missed.">      if (s != null) {</span>
<span class="nc" id="L347">        list.add(s);</span>
      }
<span class="nc" id="L349">    }</span>
<span class="nc" id="L350">    return list;</span>
  }

  public void changeLayoutModel(GridBagLayoutModel layoutModel) {
<span class="nc" id="L354">    eventManager</span>
<span class="nc" id="L355">        .getAction(ActionW.LAYOUT)</span>
<span class="nc" id="L356">        .ifPresent(itemListener -&gt; itemListener.setSelectedItem(layoutModel));</span>
<span class="nc" id="L357">  }</span>

  protected void removeComponents() {
<span class="nc bnc" id="L360" title="All 2 branches missed.">    for (Component c : components) {</span>
<span class="nc bnc" id="L361" title="All 2 branches missed.">      if (c instanceof SeriesViewerListener viewerListener) {</span>
<span class="nc" id="L362">        eventManager.removeSeriesViewerListener(viewerListener);</span>
      }
<span class="nc" id="L364">    }</span>
<span class="nc" id="L365">    components.clear();</span>
<span class="nc" id="L366">  }</span>

  protected JComponent buildInstance(Class&lt;?&gt; cl) throws Exception {
    JComponent component;
<span class="nc bnc" id="L370" title="All 2 branches missed.">    if (hasSeriesViewerConstructor(cl)) {</span>
<span class="nc" id="L371">      component = (JComponent) cl.getConstructor(SeriesViewer.class).newInstance(this);</span>
    } else {
<span class="nc" id="L373">      component = (JComponent) cl.newInstance();</span>
    }

<span class="nc bnc" id="L376" title="All 2 branches missed.">    if (component instanceof SeriesViewerListener viewerListener) {</span>
<span class="nc" id="L377">      eventManager.addSeriesViewerListener(viewerListener);</span>
    }
<span class="nc" id="L379">    return component;</span>
  }

  private boolean hasSeriesViewerConstructor(Class&lt;?&gt; clazz) {
<span class="nc bnc" id="L383" title="All 2 branches missed.">    for (Constructor&lt;?&gt; constructor : clazz.getConstructors()) {</span>
<span class="nc" id="L384">      Class&lt;?&gt;[] types = constructor.getParameterTypes();</span>
<span class="nc bnc" id="L385" title="All 4 branches missed.">      if (types.length == 1 &amp;&amp; types[0].isAssignableFrom(SeriesViewer.class)) {</span>
<span class="nc" id="L386">        return true;</span>
      }
    }
<span class="nc" id="L389">    return false;</span>
  }

  /**
   * Set a layout to this view panel. The layout is defined by the provided number corresponding the
   * layout definition in the property file.
   */
  protected synchronized void setLayoutModel(GridBagLayoutModel layoutModel) {
<span class="nc bnc" id="L397" title="All 2 branches missed.">    this.layoutModel = layoutModel == null ? VIEWS_1x1.copy() : layoutModel.copy();</span>
<span class="nc" id="L398">    grid.removeAll();</span>
    // Keep views containing images
<span class="nc" id="L400">    ArrayList&lt;ViewCanvas&lt;E&gt;&gt; oldViews = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L401" title="All 2 branches missed.">    for (ViewCanvas&lt;E&gt; v : view2ds) {</span>
<span class="nc bnc" id="L402" title="All 4 branches missed.">      if (v.getSeries() != null &amp;&amp; v.getImage() != null) {</span>
<span class="nc" id="L403">        oldViews.add(v);</span>
      } else {
<span class="nc" id="L405">        v.disposeView();</span>
      }
<span class="nc" id="L407">    }</span>
<span class="nc" id="L408">    view2ds.clear();</span>

<span class="nc" id="L410">    int nbview = getViewTypeNumber(layoutModel, view2dClass);</span>
<span class="nc bnc" id="L411" title="All 2 branches missed.">    if (oldViews.size() &gt; nbview) {</span>
<span class="nc bnc" id="L412" title="All 2 branches missed.">      for (int i = oldViews.size() - 1; i &gt;= nbview; i--) {</span>
<span class="nc" id="L413">        oldViews.remove(i).disposeView();</span>
      }
    }
<span class="nc" id="L416">    removeComponents();</span>
<span class="nc" id="L417">    GraphicSelectionListener glistener = null;</span>
<span class="nc" id="L418">    final Map&lt;LayoutConstraints, Component&gt; elements = this.layoutModel.getConstraints();</span>
<span class="nc bnc" id="L419" title="All 2 branches missed.">    for (LayoutConstraints e : elements.keySet()) {</span>
<span class="nc" id="L420">      boolean typeView2d = isViewType(view2dClass, e.getType());</span>
<span class="nc bnc" id="L421" title="All 2 branches missed.">      if (typeView2d) {</span>
        ViewCanvas&lt;E&gt; viewCanvas;
<span class="nc bnc" id="L423" title="All 2 branches missed.">        if (oldViews.isEmpty()) {</span>
<span class="nc" id="L424">          viewCanvas = createDefaultView(e.getType());</span>
<span class="nc bnc" id="L425" title="All 2 branches missed.">          if (viewCanvas != null) {</span>
<span class="nc" id="L426">            viewCanvas.registerDefaultListeners();</span>
          }
        } else {
<span class="nc" id="L429">          viewCanvas = oldViews.remove(0);</span>
        }
<span class="nc bnc" id="L431" title="All 2 branches missed.">        if (viewCanvas != null) {</span>
<span class="nc" id="L432">          view2ds.add(viewCanvas);</span>
<span class="nc" id="L433">          elements.put(e, viewCanvas.getJComponent());</span>
<span class="nc" id="L434">          grid.add(viewCanvas.getJComponent(), e);</span>
<span class="nc bnc" id="L435" title="All 2 branches missed.">          if (viewCanvas.getSeries() != null) {</span>
<span class="nc" id="L436">            viewCanvas.getSeries().setOpen(true);</span>
          }
        }
<span class="nc" id="L439">      } else {</span>
<span class="nc" id="L440">        Component component = createComponent(e.getType());</span>
<span class="nc bnc" id="L441" title="All 2 branches missed.">        if (component != null) {</span>
<span class="nc bnc" id="L442" title="All 2 branches missed.">          if (component instanceof JComponent jComponent) {</span>
<span class="nc" id="L443">            jComponent.setOpaque(true);</span>
          }
<span class="nc bnc" id="L445" title="All 2 branches missed.">          if (component instanceof HistogramView histogramView) {</span>
<span class="nc" id="L446">            glistener = histogramView;</span>
          }
<span class="nc" id="L448">          components.add(component);</span>
<span class="nc" id="L449">          elements.put(e, component);</span>
<span class="nc" id="L450">          grid.add(component, e);</span>
        }
      }
<span class="nc" id="L453">    }</span>
<span class="nc" id="L454">    grid.revalidate();</span>

<span class="nc bnc" id="L456" title="All 2 branches missed.">    if (!view2ds.isEmpty()) {</span>
<span class="nc" id="L457">      selectedImagePane = view2ds.get(0);</span>

<span class="nc" id="L459">      MouseActions mouseActions = eventManager.getMouseActions();</span>
<span class="nc" id="L460">      boolean tiledMode = SynchData.Mode.TILE.equals(synchView.getSynchData().getMode());</span>
<span class="nc bnc" id="L461" title="All 2 branches missed.">      for (int i = 0; i &lt; view2ds.size(); i++) {</span>
<span class="nc" id="L462">        ViewCanvas&lt;E&gt; v = view2ds.get(i);</span>
        // Close lens because update does not work
<span class="nc" id="L464">        v.closeLens();</span>
<span class="nc bnc" id="L465" title="All 2 branches missed.">        if (tiledMode) {</span>
<span class="nc" id="L466">          v.setTileOffset(i);</span>
<span class="nc" id="L467">          v.setSeries(selectedImagePane.getSeries(), null);</span>
        }
<span class="nc" id="L469">        v.enableMouseAndKeyListener(mouseActions);</span>
<span class="nc bnc" id="L470" title="All 2 branches missed.">        if (glistener != null) {</span>
<span class="nc" id="L471">          v.getGraphicManager().addGraphicSelectionListener(glistener);</span>
        }
      }
<span class="nc" id="L474">      selectedImagePane.setSelected(true);</span>
<span class="nc" id="L475">      eventManager.updateComponentsListener(selectedImagePane);</span>
<span class="nc bnc" id="L476" title="All 2 branches missed.">      if (selectedImagePane.getSeries() instanceof Series) {</span>
<span class="nc" id="L477">        eventManager.fireSeriesViewerListeners(</span>
            new SeriesViewerEvent(
<span class="nc" id="L479">                this, selectedImagePane.getSeries(), selectedImagePane.getImage(), EVENT.LAYOUT));</span>
      }
    }
<span class="nc" id="L482">  }</span>

  public void replaceView(ViewCanvas&lt;E&gt; oldView2d, ViewCanvas&lt;E&gt; newView2d) {
<span class="nc bnc" id="L485" title="All 4 branches missed.">    if (oldView2d != null &amp;&amp; newView2d != null) {</span>
<span class="nc" id="L486">      grid.removeAll();</span>
<span class="nc" id="L487">      final Map&lt;LayoutConstraints, Component&gt; elements = this.layoutModel.getConstraints();</span>
<span class="nc bnc" id="L488" title="All 2 branches missed.">      for (Entry&lt;LayoutConstraints, Component&gt; element : elements.entrySet()) {</span>
<span class="nc bnc" id="L489" title="All 2 branches missed.">        if (element.getValue() == oldView2d.getJComponent()) {</span>
<span class="nc bnc" id="L490" title="All 2 branches missed.">          if (selectedImagePane == oldView2d) {</span>
<span class="nc" id="L491">            selectedImagePane = newView2d;</span>
          }
<span class="nc" id="L493">          oldView2d.disposeView();</span>
<span class="nc" id="L494">          int index = view2ds.indexOf(oldView2d);</span>
<span class="nc bnc" id="L495" title="All 2 branches missed.">          if (index &gt;= 0) {</span>
<span class="nc" id="L496">            view2ds.set(index, newView2d);</span>
          }
<span class="nc" id="L498">          elements.put(element.getKey(), newView2d.getJComponent());</span>
<span class="nc" id="L499">          grid.add(newView2d.getJComponent(), element.getKey());</span>
<span class="nc bnc" id="L500" title="All 2 branches missed.">          if (newView2d.getSeries() != null) {</span>
<span class="nc" id="L501">            newView2d.getSeries().setOpen(true);</span>
          }
<span class="nc" id="L503">        } else {</span>
<span class="nc" id="L504">          grid.add(element.getValue(), element.getKey());</span>
        }
<span class="nc" id="L506">      }</span>
<span class="nc" id="L507">      grid.revalidate();</span>

<span class="nc bnc" id="L509" title="All 2 branches missed.">      if (!view2ds.isEmpty()) {</span>
<span class="nc bnc" id="L510" title="All 2 branches missed.">        if (selectedImagePane == null) {</span>
<span class="nc" id="L511">          selectedImagePane = view2ds.getFirst();</span>
        }
<span class="nc" id="L513">        MouseActions mouseActions = eventManager.getMouseActions();</span>
<span class="nc" id="L514">        boolean tiledMode = SynchData.Mode.TILE.equals(synchView.getSynchData().getMode());</span>
<span class="nc bnc" id="L515" title="All 2 branches missed.">        for (int i = 0; i &lt; view2ds.size(); i++) {</span>
<span class="nc" id="L516">          ViewCanvas&lt;E&gt; v = view2ds.get(i);</span>
          // Close lens because update does not work
<span class="nc" id="L518">          v.closeLens();</span>
<span class="nc bnc" id="L519" title="All 2 branches missed.">          if (tiledMode) {</span>
<span class="nc" id="L520">            v.setTileOffset(i);</span>
<span class="nc" id="L521">            v.setSeries(selectedImagePane.getSeries(), null);</span>
          }
<span class="nc" id="L523">          v.enableMouseAndKeyListener(mouseActions);</span>
        }
<span class="nc" id="L525">        selectedImagePane.setSelected(true);</span>
<span class="nc" id="L526">        eventManager.updateComponentsListener(selectedImagePane);</span>
      }
    }
<span class="nc" id="L529">  }</span>

  public void setSelectedImagePaneFromFocus(ViewCanvas&lt;E&gt; viewCanvas) {
<span class="nc" id="L532">    setSelectedImagePane(viewCanvas);</span>
<span class="nc" id="L533">  }</span>

  public void setSelectedImagePane(ViewCanvas&lt;E&gt; viewCanvas) {
<span class="nc bnc" id="L536" title="All 4 branches missed.">    if (this.selectedImagePane != null &amp;&amp; this.selectedImagePane.getSeries() != null) {</span>
<span class="nc" id="L537">      this.selectedImagePane.getSeries().setSelected(false, null);</span>
<span class="nc" id="L538">      this.selectedImagePane.getSeries().setFocused(false);</span>
    }
<span class="nc bnc" id="L540" title="All 4 branches missed.">    if (viewCanvas != null &amp;&amp; viewCanvas.getSeries() != null) {</span>
<span class="nc" id="L541">      viewCanvas.getSeries().setSelected(true, viewCanvas.getImage());</span>
<span class="nc bnc" id="L542" title="All 2 branches missed.">      viewCanvas.getSeries().setFocused(eventManager.getSelectedView2dContainer() == this);</span>
    }

<span class="nc bnc" id="L545" title="All 4 branches missed.">    boolean newView = this.selectedImagePane != viewCanvas &amp;&amp; viewCanvas != null;</span>
<span class="nc bnc" id="L546" title="All 2 branches missed.">    if (newView) {</span>
<span class="nc bnc" id="L547" title="All 2 branches missed.">      if (this.selectedImagePane != null) {</span>
<span class="nc" id="L548">        this.selectedImagePane.setSelected(false);</span>
      }
<span class="nc" id="L550">      viewCanvas.setSelected(true);</span>
<span class="nc" id="L551">      this.selectedImagePane = viewCanvas;</span>
<span class="nc" id="L552">      eventManager.updateComponentsListener(viewCanvas);</span>
    }
<span class="nc bnc" id="L554" title="All 4 branches missed.">    if (newView &amp;&amp; viewCanvas.getSeries() instanceof Series) {</span>
<span class="nc" id="L555">      eventManager.fireSeriesViewerListeners(</span>
          new SeriesViewerEvent(
<span class="nc" id="L557">              this, selectedImagePane.getSeries(), selectedImagePane.getImage(), EVENT.SELECT));</span>
    }
<span class="nc" id="L559">    eventManager.fireSeriesViewerListeners(</span>
        new SeriesViewerEvent(
<span class="nc bnc" id="L561" title="All 2 branches missed.">            this, viewCanvas == null ? null : viewCanvas.getSeries(), null, EVENT.SELECT_VIEW));</span>
<span class="nc" id="L562">  }</span>

  public void resetMaximizedSelectedImagePane(final ViewCanvas&lt;E&gt; viewCanvas) {
<span class="nc bnc" id="L565" title="All 2 branches missed.">    if (grid.getComponentCount() == 1) {</span>
<span class="nc" id="L566">      Dialog fullscreenDialog = WinUtil.getParentDialog(grid);</span>
<span class="nc bnc" id="L567" title="All 2 branches missed.">      if (fullscreenDialog != null</span>
          &amp;&amp; fullscreenDialog
<span class="nc" id="L569">              .getTitle()</span>
<span class="nc bnc" id="L570" title="All 2 branches missed.">              .equals(Messages.getString(&quot;ImageViewerPlugin.fullscreen&quot;))) {</span>
<span class="nc" id="L571">        maximizedSelectedImagePane(viewCanvas, null);</span>
      }
    }
<span class="nc" id="L574">  }</span>

  public void maximizedSelectedImagePane(final ViewCanvas&lt;E&gt; defaultView2d, MouseEvent evt) {
<span class="nc" id="L577">    final Map&lt;LayoutConstraints, Component&gt; elements = layoutModel.getConstraints();</span>
    // Prevent conflict with double click for stopping to draw a graphic (like polyline)

<span class="nc" id="L580">    List&lt;DragGraphic&gt; selGraphics =</span>
<span class="nc" id="L581">        defaultView2d.getGraphicManager().getSelectedDraggableGraphics();</span>

    // Check if there is at least one graphic not complete (numer of pts == UNDEFINED)
<span class="nc bnc" id="L584" title="All 2 branches missed.">    if (selGraphics.stream().anyMatch(g -&gt; Objects.equals(g.getPtsNumber(), Graphic.UNDEFINED))) {</span>
<span class="nc" id="L585">      return;</span>
    }

<span class="nc bnc" id="L588" title="All 2 branches missed.">    if (evt != null) {</span>
      // Do not maximize when click hits a graphic
<span class="nc" id="L590">      MouseEventDouble mouseEvt = new MouseEventDouble(evt);</span>
<span class="nc" id="L591">      mouseEvt.setImageCoordinates(</span>
<span class="nc" id="L592">          defaultView2d.getImageCoordinatesFromMouse(evt.getX(), evt.getY()));</span>

<span class="nc bnc" id="L594" title="All 2 branches missed.">      if (defaultView2d.getGraphicManager().getFirstGraphicIntersecting(mouseEvt).isPresent()) {</span>
<span class="nc" id="L595">        return;</span>
      }
    }

<span class="nc bnc" id="L599" title="All 2 branches missed.">    for (ViewCanvas&lt;E&gt; v : view2ds) {</span>
<span class="nc" id="L600">      v.getJComponent().removeFocusListener(v);</span>
<span class="nc" id="L601">    }</span>

<span class="nc" id="L603">    String titleDialog = Messages.getString(&quot;ImageViewerPlugin.fullscreen&quot;);</span>
<span class="nc" id="L604">    Dialog fullscreenDialog = WinUtil.getParentDialog(grid);</span>
    // Handle the case when the dialog is a detached window and not the fullscreen window.
<span class="nc bnc" id="L606" title="All 2 branches missed.">    final boolean detachedWindow =</span>
<span class="nc bnc" id="L607" title="All 2 branches missed.">        fullscreenDialog != null &amp;&amp; !titleDialog.equals(fullscreenDialog.getTitle());</span>

<span class="nc" id="L609">    grid.removeAll();</span>
<span class="nc bnc" id="L610" title="All 4 branches missed.">    if (detachedWindow || fullscreenDialog == null) {</span>
<span class="nc" id="L611">      remove(grid);</span>
<span class="nc bnc" id="L612" title="All 2 branches missed.">      for (Entry&lt;LayoutConstraints, Component&gt; entry : elements.entrySet()) {</span>
<span class="nc bnc" id="L613" title="All 2 branches missed.">        if (entry.getValue().equals(defaultView2d.getJComponent())) {</span>
<span class="nc" id="L614">          GridBagConstraints c = entry.getKey().copy();</span>
<span class="nc" id="L615">          c.weightx = 1.0;</span>
<span class="nc" id="L616">          c.weighty = 1.0;</span>
<span class="nc" id="L617">          grid.add(defaultView2d.getJComponent(), c);</span>
<span class="nc" id="L618">          defaultView2d.getJComponent().addFocusListener(defaultView2d);</span>
<span class="nc" id="L619">          break;</span>
        }
<span class="nc" id="L621">      }</span>
<span class="nc" id="L622">      Dialog oldDialog = fullscreenDialog;</span>
<span class="nc" id="L623">      Frame frame = WinUtil.getParentFrame(this);</span>
<span class="nc" id="L624">      fullscreenDialog =</span>
          new JDialog(
<span class="nc bnc" id="L626" title="All 2 branches missed.">              detachedWindow ? oldDialog : frame, titleDialog, ModalityType.APPLICATION_MODAL);</span>
<span class="nc" id="L627">      fullscreenDialog.add(grid, BorderLayout.CENTER);</span>
<span class="nc" id="L628">      fullscreenDialog.addWindowListener(</span>
<span class="nc" id="L629">          new WindowAdapter() {</span>

            @Override
            public void windowClosing(WindowEvent e) {
<span class="nc" id="L633">              maximizedSelectedImagePane(defaultView2d, null);</span>
<span class="nc" id="L634">            }</span>
          });

<span class="nc bnc" id="L637" title="All 2 branches missed.">      if (!detachedWindow</span>
<span class="nc bnc" id="L638" title="All 2 branches missed.">          &amp;&amp; (frame.getExtendedState() &amp; Frame.MAXIMIZED_BOTH) == Frame.MAXIMIZED_BOTH) {</span>
<span class="nc" id="L639">        fullscreenDialog.setBounds(frame.getBounds());</span>
<span class="nc" id="L640">        fullscreenDialog.setVisible(true);</span>
      } else {
        Monitor monitor =
<span class="nc" id="L643">            Monitor.getMonitor(</span>
<span class="nc bnc" id="L644" title="All 2 branches missed.">                detachedWindow</span>
<span class="nc" id="L645">                    ? oldDialog.getGraphicsConfiguration()</span>
<span class="nc" id="L646">                    : frame.getGraphicsConfiguration());</span>
<span class="nc bnc" id="L647" title="All 2 branches missed.">        if (monitor != null) {</span>
<span class="nc" id="L648">          fullscreenDialog.setBounds(monitor.getFullscreenBounds());</span>
<span class="nc" id="L649">          fullscreenDialog.setVisible(true);</span>
        }
      }

<span class="nc" id="L653">    } else {</span>
<span class="nc bnc" id="L654" title="All 2 branches missed.">      for (Entry&lt;LayoutConstraints, Component&gt; entry : elements.entrySet()) {</span>
<span class="nc" id="L655">        grid.add(entry.getValue(), entry.getKey());</span>
<span class="nc" id="L656">      }</span>
<span class="nc bnc" id="L657" title="All 2 branches missed.">      for (ViewCanvas&lt;E&gt; v : view2ds) {</span>
<span class="nc" id="L658">        v.getJComponent().addFocusListener(v);</span>
<span class="nc" id="L659">      }</span>

<span class="nc" id="L661">      fullscreenDialog.removeAll();</span>
<span class="nc" id="L662">      fullscreenDialog.dispose();</span>
<span class="nc" id="L663">      add(grid, BorderLayout.CENTER);</span>

<span class="nc" id="L665">      defaultView2d.getJComponent().requestFocusInWindow();</span>
    }
<span class="nc" id="L667">  }</span>

  /** Return the image in the image display panel. */
  public E getImage(int i) {
<span class="nc bnc" id="L671" title="All 4 branches missed.">    if (i &gt;= 0 &amp;&amp; i &lt; view2ds.size()) {</span>
<span class="nc" id="L672">      return view2ds.get(i).getImage();</span>
    }
<span class="nc" id="L674">    return null;</span>
  }

  /** Return all the &lt;code&gt;ImagePanel&lt;/code&gt;s. */
  public List&lt;ViewCanvas&lt;E&gt;&gt; getImagePanels() {
<span class="nc" id="L679">    return getImagePanels(false);</span>
  }

  public List&lt;ViewCanvas&lt;E&gt;&gt; getImagePanels(boolean selectedImagePaneLast) {
<span class="nc" id="L683">    List&lt;ViewCanvas&lt;E&gt;&gt; viewList = new ArrayList&lt;&gt;(view2ds);</span>
<span class="nc bnc" id="L684" title="All 2 branches missed.">    if (selectedImagePaneLast) {</span>
<span class="nc" id="L685">      ViewCanvas&lt;E&gt; selectedView = getSelectedImagePane();</span>

<span class="nc bnc" id="L687" title="All 4 branches missed.">      if (selectedView != null &amp;&amp; viewList.size() &gt; 1) {</span>
<span class="nc" id="L688">        viewList.remove(selectedView);</span>
<span class="nc" id="L689">        viewList.add(selectedView);</span>
      }
<span class="nc" id="L691">      return viewList;</span>
    }
<span class="nc" id="L693">    return viewList;</span>
  }

  public ViewCanvas&lt;E&gt; getNextSelectedImagePane() {
<span class="nc bnc" id="L697" title="All 2 branches missed.">    for (int i = 0; i &lt; view2ds.size() - 1; i++) {</span>
<span class="nc bnc" id="L698" title="All 2 branches missed.">      if (view2ds.get(i) == selectedImagePane) {</span>
<span class="nc" id="L699">        return view2ds.get(i + 1);</span>
      }
    }
<span class="nc" id="L702">    return selectedImagePane;</span>
  }

  public abstract List&lt;SynchView&gt; getSynchList();

  public abstract List&lt;GridBagLayoutModel&gt; getLayoutList();

  public Boolean isContainingView(ViewCanvas&lt;?&gt; view2DPane) {
<span class="nc" id="L710">    return view2ds.stream()</span>
<span class="nc" id="L711">        .filter(v -&gt; Objects.equals(v, view2DPane))</span>
<span class="nc" id="L712">        .findFirst()</span>
<span class="nc" id="L713">        .map(v -&gt; Boolean.TRUE)</span>
<span class="nc" id="L714">        .orElse(Boolean.FALSE);</span>
  }

  public SynchView getSynchView() {
<span class="nc" id="L718">    return synchView;</span>
  }

  public void setSynchView(SynchView synchView) {
<span class="nc" id="L722">    this.synchView = Objects.requireNonNull(synchView);</span>
<span class="nc" id="L723">    updateTileOffset();</span>
<span class="nc" id="L724">    eventManager.updateAllListeners(this, synchView);</span>
<span class="nc" id="L725">  }</span>

  public void updateTileOffset() {
<span class="nc bnc" id="L728" title="All 4 branches missed.">    if (SynchData.Mode.TILE.equals(synchView.getSynchData().getMode())</span>
        &amp;&amp; selectedImagePane != null) {
<span class="nc" id="L730">      MediaSeries&lt;E&gt; series = null;</span>
<span class="nc" id="L731">      ViewCanvas&lt;E&gt; selectedView = selectedImagePane;</span>
<span class="nc bnc" id="L732" title="All 2 branches missed.">      if (selectedImagePane.getSeries() != null) {</span>
<span class="nc" id="L733">        series = selectedImagePane.getSeries();</span>
      } else {
<span class="nc bnc" id="L735" title="All 2 branches missed.">        for (ViewCanvas&lt;E&gt; v : view2ds) {</span>
<span class="nc bnc" id="L736" title="All 2 branches missed.">          if (v.getSeries() != null) {</span>
<span class="nc" id="L737">            series = v.getSeries();</span>
<span class="nc" id="L738">            selectedView = v;</span>
<span class="nc" id="L739">            break;</span>
          }
<span class="nc" id="L741">        }</span>
      }
<span class="nc bnc" id="L743" title="All 2 branches missed.">      if (series != null) {</span>
        @SuppressWarnings(&quot;unchecked&quot;)
<span class="nc" id="L745">        int limit =</span>
<span class="nc" id="L746">            series.size((Filter&lt;E&gt;) selectedView.getActionValue(ActionW.FILTERED_SERIES.cmd()));</span>
<span class="nc bnc" id="L747" title="All 2 branches missed.">        for (int i = 0; i &lt; view2ds.size(); i++) {</span>
<span class="nc" id="L748">          ViewCanvas&lt;E&gt; v = view2ds.get(i);</span>
<span class="nc bnc" id="L749" title="All 2 branches missed.">          if (i &lt; limit) {</span>
<span class="nc" id="L750">            v.setTileOffset(i);</span>
<span class="nc" id="L751">            v.setSeries(series, null);</span>
          } else {
<span class="nc" id="L753">            v.setSeries(null, null);</span>
          }
        }
      }
<span class="nc" id="L757">    } else {</span>
<span class="nc bnc" id="L758" title="All 2 branches missed.">      for (ViewCanvas&lt;E&gt; v : view2ds) {</span>
<span class="nc" id="L759">        v.setTileOffset(0);</span>
<span class="nc" id="L760">      }</span>
    }
<span class="nc" id="L762">  }</span>

  public synchronized void setMouseActions(MouseActions mouseActions) {
<span class="nc bnc" id="L765" title="All 2 branches missed.">    if (mouseActions == null) {</span>
<span class="nc bnc" id="L766" title="All 2 branches missed.">      for (ViewCanvas&lt;E&gt; v : view2ds) {</span>
<span class="nc" id="L767">        v.disableMouseAndKeyListener();</span>
        // Let the possibility get the focus
<span class="nc" id="L769">        v.iniDefaultMouseListener();</span>
<span class="nc" id="L770">      }</span>
    } else {
<span class="nc bnc" id="L772" title="All 2 branches missed.">      for (ViewCanvas&lt;E&gt; v : view2ds) {</span>
<span class="nc" id="L773">        v.enableMouseAndKeyListener(mouseActions);</span>
<span class="nc" id="L774">      }</span>
    }
<span class="nc" id="L776">  }</span>

  public GridBagLayoutModel getBestDefaultViewLayout(int size) {
<span class="nc bnc" id="L779" title="All 2 branches missed.">    if (size &lt;= 1) {</span>
<span class="nc" id="L780">      return getDefaultLayoutModel();</span>
    }
<span class="nc" id="L782">    Optional&lt;ComboItemListener&lt;GridBagLayoutModel&gt;&gt; layout = eventManager.getAction(ActionW.LAYOUT);</span>
<span class="nc bnc" id="L783" title="All 2 branches missed.">    if (layout.isPresent()) {</span>
<span class="nc" id="L784">      Object[] list = layout.get().getAllItem();</span>
<span class="nc" id="L785">      GridBagLayoutModel bestModel = getDefaultLayoutModel();</span>
<span class="nc" id="L786">      int diff = Integer.MAX_VALUE;</span>
<span class="nc" id="L787">      int diffLayout = Integer.MAX_VALUE;</span>
<span class="nc bnc" id="L788" title="All 2 branches missed.">      for (Object m : list) {</span>
<span class="nc bnc" id="L789" title="All 2 branches missed.">        if (m instanceof GridBagLayoutModel model) {</span>
<span class="nc" id="L790">          int layoutSize = getViewTypeNumber(model, getSeriesViewerClass());</span>
<span class="nc" id="L791">          int layoutDiff = Math.abs(layoutSize - size);</span>
<span class="nc bnc" id="L792" title="All 4 branches missed.">          if (layoutSize &gt;= size &amp;&amp; layoutDiff &lt;= diff) {</span>
<span class="nc bnc" id="L793" title="All 2 branches missed.">            if (layoutDiff == diff) {</span>
<span class="nc" id="L794">              Dimension dim = model.getGridSize();</span>
<span class="nc bnc" id="L795" title="All 2 branches missed.">              if (Math.abs(dim.width - dim.height) &lt; diffLayout) {</span>
<span class="nc" id="L796">                diffLayout = Math.abs(dim.width - dim.height);</span>
              } else {
                continue;
              }
            }
<span class="nc" id="L801">            diff = layoutDiff;</span>
<span class="nc" id="L802">            bestModel = model;</span>
          }
        }
      }
<span class="nc" id="L806">      return bestModel;</span>
    }

<span class="nc" id="L809">    return getDefaultLayoutModel();</span>
  }

  protected static ArrayList&lt;GridBagLayoutModel&gt; getLayoutList(
      ImageViewerPlugin&lt;?&gt; viewerPlugin, List&lt;GridBagLayoutModel&gt; bagLayoutModels) {
<span class="nc" id="L814">    int rx = 1;</span>
<span class="nc" id="L815">    int ry = 1;</span>
<span class="nc" id="L816">    int width = viewerPlugin.getWidth();</span>
<span class="nc" id="L817">    int height = viewerPlugin.getHeight();</span>
<span class="nc" id="L818">    double ratio = width / (double) height;</span>
<span class="nc bnc" id="L819" title="All 2 branches missed.">    if (ratio &gt;= 1.0) {</span>
<span class="nc" id="L820">      rx = (int) Math.round(ratio * 1.5);</span>
    } else {
<span class="nc" id="L822">      ry = (int) Math.round((1.0 / ratio) * 1.5);</span>
    }

<span class="nc" id="L825">    ArrayList&lt;GridBagLayoutModel&gt; list = new ArrayList&lt;&gt;(bagLayoutModels);</span>
<span class="nc" id="L826">    int rxMin = rx;</span>
<span class="nc" id="L827">    int ryMin = ry;</span>
<span class="nc bnc" id="L828" title="All 2 branches missed.">    for (GridBagLayoutModel model : bagLayoutModels) {</span>
<span class="nc" id="L829">      Dimension dim = model.getGridSize();</span>
<span class="nc bnc" id="L830" title="All 2 branches missed.">      if (dim.width &gt; rxMin) {</span>
<span class="nc" id="L831">        rxMin = dim.width;</span>
      }
<span class="nc bnc" id="L833" title="All 2 branches missed.">      if (dim.height &gt; ryMin) {</span>
<span class="nc" id="L834">        ryMin = dim.height;</span>
      }
<span class="nc" id="L836">    }</span>

    // Exclude 1x1
<span class="nc bnc" id="L839" title="All 6 branches missed.">    if (rx != ry &amp;&amp; rx != 0 &amp;&amp; ry != 0) {</span>
<span class="nc bnc" id="L840" title="All 2 branches missed.">      int factorLimit = (int) (rx == 1 ? Math.round(width / 512.0) : Math.round(height / 512.0));</span>
<span class="nc bnc" id="L841" title="All 2 branches missed.">      if (factorLimit &lt; 1) {</span>
<span class="nc" id="L842">        factorLimit = 1;</span>
      }
<span class="nc bnc" id="L844" title="All 2 branches missed.">      if (rx &gt; ry) {</span>
<span class="nc" id="L845">        int step = 1 + (rx / 20);</span>
<span class="nc bnc" id="L846" title="All 2 branches missed.">        for (int i = rx / 2; i &lt; rx; i = i + step) {</span>
<span class="nc" id="L847">          addLayout(list, factorLimit, i, ry, rxMin, ryMin);</span>
        }
<span class="nc" id="L849">      } else {</span>
<span class="nc" id="L850">        int step = 1 + (ry / 20);</span>
<span class="nc bnc" id="L851" title="All 2 branches missed.">        for (int i = ry / 2; i &lt; ry; i = i + step) {</span>
<span class="nc" id="L852">          addLayout(list, factorLimit, rx, i, rxMin, ryMin);</span>
        }
      }
<span class="nc" id="L855">      addLayout(list, factorLimit, rx, ry, rxMin, ryMin);</span>
    }
<span class="nc" id="L857">    list.sort(Comparator.comparingInt(o -&gt; o.getConstraints().size()));</span>
<span class="nc" id="L858">    return list;</span>
  }

  private static void addLayout(
      List&lt;GridBagLayoutModel&gt; list, int factorLimit, int rx, int ry, int rxMin, int ryMin) {
<span class="nc bnc" id="L863" title="All 2 branches missed.">    for (int i = 1; i &lt;= factorLimit; i++) {</span>
<span class="nc bnc" id="L864" title="All 6 branches missed.">      if (i &gt; 2 || i * ry &gt; ryMin || i * rx &gt; rxMin) {</span>
<span class="nc bnc" id="L865" title="All 4 branches missed.">        if (i * ry &lt; 50 &amp;&amp; i * rx &lt; 50) {</span>
<span class="nc" id="L866">          list.add(</span>
<span class="nc" id="L867">              ImageViewerPlugin.buildGridBagLayoutModel(i * ry, i * rx, view2dClass.getName()));</span>
        }
      }
    }
<span class="nc" id="L871">  }</span>

  public static GridBagLayoutModel getBestDefaultViewLayout(
      ActionState layout, int size, GridBagLayoutModel defaultModel) {
<span class="nc bnc" id="L875" title="All 2 branches missed.">    if (size &lt;= 1) {</span>
<span class="nc" id="L876">      return defaultModel;</span>
    }
<span class="nc bnc" id="L878" title="All 2 branches missed.">    if (layout instanceof ComboItemListener&lt;?&gt; comboItemListener) {</span>
<span class="nc" id="L879">      Object[] list = comboItemListener.getAllItem();</span>
<span class="nc" id="L880">      GridBagLayoutModel bestModel = defaultModel;</span>
<span class="nc" id="L881">      int diffNumber = Integer.MAX_VALUE;</span>
<span class="nc" id="L882">      int diffLayout = Integer.MAX_VALUE;</span>
<span class="nc bnc" id="L883" title="All 2 branches missed.">      for (Object m : list) {</span>
<span class="nc bnc" id="L884" title="All 2 branches missed.">        if (m instanceof GridBagLayoutModel model) {</span>
<span class="nc" id="L885">          int layoutSize = getViewTypeNumber(model);</span>
<span class="nc" id="L886">          int dn = Math.abs(layoutSize - size);</span>
<span class="nc bnc" id="L887" title="All 4 branches missed.">          if (layoutSize &gt;= size &amp;&amp; dn &lt;= diffNumber) {</span>
<span class="nc" id="L888">            Dimension dim = model.getGridSize();</span>
<span class="nc bnc" id="L889" title="All 2 branches missed.">            if (dn == diffNumber) {</span>
<span class="nc" id="L890">              int dwh = Math.abs(dim.width - dim.height);</span>
<span class="nc bnc" id="L891" title="All 2 branches missed.">              if (dwh &lt; diffLayout) {</span>
<span class="nc" id="L892">                diffLayout = dwh;</span>
<span class="nc bnc" id="L893" title="All 4 branches missed.">              } else if (dwh == diffLayout &amp;&amp; dim.width &gt; dim.height) {</span>
<span class="nc" id="L894">                diffLayout = dwh;</span>
              } else {
                continue;
              }
            }
<span class="nc" id="L899">            diffNumber = dn;</span>
<span class="nc" id="L900">            bestModel = model;</span>
          }
        }
      }
<span class="nc" id="L904">      return bestModel;</span>
    }
<span class="nc" id="L906">    return defaultModel;</span>
  }

  public static int getViewTypeNumber(GridBagLayoutModel layout) {
<span class="nc" id="L910">    int val = 0;</span>
<span class="nc bnc" id="L911" title="All 2 branches missed.">    if (layout != null) {</span>
<span class="nc bnc" id="L912" title="All 2 branches missed.">      for (LayoutConstraints layoutConstraints : layout.getConstraints().keySet()) {</span>
<span class="nc bnc" id="L913" title="All 2 branches missed.">        if (layoutConstraints.getColor() == null) {</span>
<span class="nc" id="L914">          val++;</span>
        }
<span class="nc" id="L916">      }</span>
    }
<span class="nc" id="L918">    return val;</span>
  }

  public GridBagLayoutModel getViewLayout(String title) {
<span class="nc bnc" id="L922" title="All 2 branches missed.">    if (title != null) {</span>
<span class="nc" id="L923">      Optional&lt;ComboItemListener&lt;GridBagLayoutModel&gt;&gt; layout =</span>
<span class="nc" id="L924">          eventManager.getAction(ActionW.LAYOUT);</span>
<span class="nc bnc" id="L925" title="All 2 branches missed.">      if (layout.isPresent()) {</span>
<span class="nc" id="L926">        Object[] list = layout.get().getAllItem();</span>
<span class="nc bnc" id="L927" title="All 2 branches missed.">        for (Object m : list) {</span>
<span class="nc bnc" id="L928" title="All 4 branches missed.">          if (m instanceof GridBagLayoutModel model &amp;&amp; title.equals(model.getId())) {</span>
<span class="nc" id="L929">            return model;</span>
          }
        }
      }
    }
<span class="nc" id="L934">    return VIEWS_1x1;</span>
  }

  public void addSeriesList(List&lt;MediaSeries&lt;E&gt;&gt; seriesList, boolean bestDefaultLayout) {
<span class="nc bnc" id="L938" title="All 4 branches missed.">    if (seriesList != null &amp;&amp; !seriesList.isEmpty()) {</span>
<span class="nc bnc" id="L939" title="All 2 branches missed.">      if (SynchData.Mode.TILE.equals(synchView.getSynchData().getMode())) {</span>
<span class="nc" id="L940">        addSeries(seriesList.getFirst());</span>
<span class="nc" id="L941">        return;</span>
      }
<span class="nc" id="L943">      setSelectedAndGetFocus();</span>
<span class="nc bnc" id="L944" title="All 2 branches missed.">      if (bestDefaultLayout) {</span>
<span class="nc" id="L945">        changeLayoutModel(getBestDefaultViewLayout(seriesList.size()));</span>

        // If the layout is larger than the list of series, clean other views.
<span class="nc bnc" id="L948" title="All 2 branches missed.">        if (view2ds.size() &gt; seriesList.size()) {</span>
<span class="nc" id="L949">          setSelectedImagePane(view2ds.get(seriesList.size()));</span>
<span class="nc bnc" id="L950" title="All 2 branches missed.">          for (int i = seriesList.size(); i &lt; view2ds.size(); i++) {</span>
<span class="nc" id="L951">            ViewCanvas&lt;E&gt; viewPane = getSelectedImagePane();</span>
<span class="nc bnc" id="L952" title="All 2 branches missed.">            if (viewPane != null) {</span>
<span class="nc" id="L953">              viewPane.setSeries(null, null);</span>
            }
<span class="nc" id="L955">            getNextSelectedImagePane();</span>
          }
        }
<span class="nc bnc" id="L958" title="All 2 branches missed.">        if (!view2ds.isEmpty()) {</span>
<span class="nc" id="L959">          setSelectedImagePane(view2ds.getFirst());</span>
        }
<span class="nc bnc" id="L961" title="All 2 branches missed.">        for (MediaSeries mediaSeries : seriesList) {</span>
<span class="nc" id="L962">          addSeries(mediaSeries);</span>
<span class="nc" id="L963">        }</span>
      } else {
<span class="nc" id="L965">        int emptyView = 0;</span>
<span class="nc bnc" id="L966" title="All 2 branches missed.">        for (ViewCanvas&lt;E&gt; v : view2ds) {</span>
<span class="nc bnc" id="L967" title="All 2 branches missed.">          if (v.getSeries() == null) {</span>
<span class="nc" id="L968">            emptyView++;</span>
          }
<span class="nc" id="L970">        }</span>
<span class="nc bnc" id="L971" title="All 2 branches missed.">        if (emptyView &lt; seriesList.size()) {</span>
<span class="nc" id="L972">          changeLayoutModel(getBestDefaultViewLayout(view2ds.size() + seriesList.size()));</span>
        }
<span class="nc" id="L974">        int index = 0;</span>
<span class="nc bnc" id="L975" title="All 2 branches missed.">        for (ViewCanvas&lt;E&gt; v : view2ds) {</span>
<span class="nc bnc" id="L976" title="All 4 branches missed.">          if (v.getSeries() == null &amp;&amp; index &lt; seriesList.size()) {</span>
<span class="nc" id="L977">            setSelectedImagePane(v);</span>
<span class="nc" id="L978">            addSeries(seriesList.get(index));</span>
<span class="nc" id="L979">            index++;</span>
          }
<span class="nc" id="L981">        }</span>
      }
<span class="nc" id="L983">      repaint();</span>
    }
<span class="nc" id="L985">  }</span>

<span class="nc" id="L987">  class MouseHandler extends MouseAdapter {</span>
<span class="nc" id="L988">    private Point pickPoint = null;</span>
<span class="nc" id="L989">    private Point point = null;</span>
<span class="nc" id="L990">    private boolean splitVertical = false;</span>
<span class="nc" id="L991">    private final ArrayList&lt;ImageViewerPlugin.DragLayoutElement&gt; list = new ArrayList&lt;&gt;();</span>

    @Override
    public void mousePressed(MouseEvent e) {
<span class="nc" id="L995">      pickPoint = e.getPoint();</span>
<span class="nc" id="L996">      point = null;</span>
<span class="nc" id="L997">      list.clear();</span>
<span class="nc" id="L998">      Iterator&lt;Entry&lt;LayoutConstraints, Component&gt;&gt; enumVal =</span>
<span class="nc" id="L999">          ImageViewerPlugin.this.layoutModel.getConstraints().entrySet().iterator();</span>
      Entry&lt;LayoutConstraints, Component&gt; entry;
<span class="nc bnc" id="L1001" title="All 2 branches missed.">      while (enumVal.hasNext()) {</span>
<span class="nc" id="L1002">        entry = enumVal.next();</span>
<span class="nc" id="L1003">        Component c = entry.getValue();</span>
<span class="nc bnc" id="L1004" title="All 2 branches missed.">        if (c != null) {</span>
<span class="nc" id="L1005">          Rectangle rect = c.getBounds();</span>
<span class="nc bnc" id="L1006" title="All 6 branches missed.">          if (Math.abs(rect.x - pickPoint.x) &lt;= LayoutConstraints.SPACE</span>
              &amp;&amp; (pickPoint.y &gt;= rect.y &amp;&amp; pickPoint.y &lt;= rect.y + rect.height)
<span class="nc bnc" id="L1008" title="All 2 branches missed.">              &amp;&amp; entry.getKey().gridx &gt; 0) {</span>
<span class="nc" id="L1009">            splitVertical = true;</span>
<span class="nc" id="L1010">            point = new Point(entry.getKey().gridx, entry.getKey().gridy);</span>
<span class="nc" id="L1011">            break;</span>
<span class="nc bnc" id="L1012" title="All 6 branches missed.">          } else if (Math.abs(rect.y - pickPoint.y) &lt;= LayoutConstraints.SPACE</span>
              &amp;&amp; (pickPoint.x &gt;= rect.x &amp;&amp; pickPoint.x &lt;= rect.x + rect.width)
<span class="nc bnc" id="L1014" title="All 2 branches missed.">              &amp;&amp; entry.getKey().gridy &gt; 0) {</span>
<span class="nc" id="L1015">            splitVertical = false;</span>
<span class="nc" id="L1016">            point = new Point(entry.getKey().gridx, entry.getKey().gridy);</span>
<span class="nc" id="L1017">            break;</span>
          }
        }
<span class="nc" id="L1020">      }</span>
<span class="nc bnc" id="L1021" title="All 2 branches missed.">      if (point != null) {</span>
<span class="nc" id="L1022">        enumVal = ImageViewerPlugin.this.layoutModel.getConstraints().entrySet().iterator();</span>
<span class="nc bnc" id="L1023" title="All 2 branches missed.">        while (enumVal.hasNext()) {</span>
<span class="nc" id="L1024">          entry = enumVal.next();</span>
<span class="nc" id="L1025">          Component c = entry.getValue();</span>
<span class="nc bnc" id="L1026" title="All 2 branches missed.">          if (c != null) {</span>
<span class="nc" id="L1027">            list.add(new DragLayoutElement(entry.getKey(), c));</span>
          }
<span class="nc" id="L1029">        }</span>

<span class="nc" id="L1031">        Rectangle b = grid.getBounds();</span>
<span class="nc" id="L1032">        double totalWidth = b.getWidth();</span>
<span class="nc" id="L1033">        double totalHeight = b.getHeight();</span>

<span class="nc bnc" id="L1035" title="All 2 branches missed.">        for (DragLayoutElement el : list) {</span>
<span class="nc" id="L1036">          el.originalConstraints.weightx = el.originalBound.width / totalWidth;</span>
<span class="nc" id="L1037">          el.originalConstraints.weighty = el.originalBound.height / totalHeight;</span>
<span class="nc" id="L1038">          el.constraints.weightx = el.originalConstraints.weightx;</span>
<span class="nc" id="L1039">          el.constraints.weighty = el.originalConstraints.weighty;</span>
<span class="nc" id="L1040">        }</span>
      }
<span class="nc" id="L1042">    }</span>

    @Override
    public void mouseReleased(MouseEvent mouseevent) {
<span class="nc" id="L1046">      pickPoint = null;</span>
<span class="nc" id="L1047">      point = null;</span>
<span class="nc" id="L1048">      list.clear();</span>
<span class="nc" id="L1049">    }</span>

    @Override
    public void mouseDragged(MouseEvent e) {
<span class="nc" id="L1053">      int mods = e.getModifiers();</span>
<span class="nc bnc" id="L1054" title="All 4 branches missed.">      if (pickPoint != null</span>
          &amp;&amp; point != null
<span class="nc bnc" id="L1056" title="All 4 branches missed.">          &amp;&amp; list.size() &gt; 1</span>
          &amp;&amp; (mods &amp; InputEvent.BUTTON1_MASK) != 0) {
<span class="nc" id="L1058">        Point p = e.getPoint();</span>
<span class="nc bnc" id="L1059" title="All 2 branches missed.">        if (splitVertical) {</span>
<span class="nc" id="L1060">          int dx = p.x - pickPoint.x;</span>
<span class="nc" id="L1061">          int limitdx = dx;</span>
<span class="nc bnc" id="L1062" title="All 2 branches missed.">          for (DragLayoutElement element : list) {</span>
<span class="nc" id="L1063">            LayoutConstraints key = element.getConstraints();</span>
<span class="nc bnc" id="L1064" title="All 2 branches missed.">            if (key.gridx == point.x) {</span>
<span class="nc" id="L1065">              int width = element.getOriginalBound().width - dx;</span>
<span class="nc" id="L1066">              Dimension min = element.getComponent().getMinimumSize();</span>
<span class="nc bnc" id="L1067" title="All 2 branches missed.">              int minsize = min == null ? 50 : min.width;</span>
<span class="nc bnc" id="L1068" title="All 2 branches missed.">              if (width &lt; minsize) {</span>
<span class="nc" id="L1069">                limitdx = dx - (minsize - width);</span>
              }
<span class="nc bnc" id="L1071" title="All 2 branches missed.">            } else if (key.gridx + key.gridwidth == point.x) {</span>
<span class="nc" id="L1072">              int width = element.getOriginalBound().width + dx;</span>
<span class="nc" id="L1073">              Dimension min = element.getComponent().getMinimumSize();</span>
<span class="nc bnc" id="L1074" title="All 2 branches missed.">              int minsize = min == null ? 50 : min.width;</span>
<span class="nc bnc" id="L1075" title="All 2 branches missed.">              if (width &lt; minsize) {</span>
<span class="nc" id="L1076">                limitdx = dx + (minsize - width);</span>
              }
            }
<span class="nc" id="L1079">          }</span>
<span class="nc bnc" id="L1080" title="All 2 branches missed.">          for (DragLayoutElement element : list) {</span>
<span class="nc" id="L1081">            LayoutConstraints key = element.getConstraints();</span>
<span class="nc" id="L1082">            LayoutConstraints originkey = element.getOriginalConstraints();</span>
<span class="nc bnc" id="L1083" title="All 2 branches missed.">            if (key.gridx == point.x) {</span>
<span class="nc" id="L1084">              key.weightx =</span>
                  originkey.weightx
<span class="nc" id="L1086">                      - limitdx * originkey.weightx / element.getOriginalBound().width;</span>
<span class="nc bnc" id="L1087" title="All 2 branches missed.">            } else if (key.gridx + key.gridwidth == point.x) {</span>
<span class="nc" id="L1088">              key.weightx =</span>
                  originkey.weightx
<span class="nc" id="L1090">                      + limitdx * originkey.weightx / element.getOriginalBound().width;</span>
            }
<span class="nc" id="L1092">          }</span>
<span class="nc" id="L1093">        } else {</span>
<span class="nc" id="L1094">          int dy = p.y - pickPoint.y;</span>
<span class="nc" id="L1095">          int limitdy = dy;</span>
<span class="nc bnc" id="L1096" title="All 2 branches missed.">          for (DragLayoutElement element : list) {</span>
<span class="nc" id="L1097">            LayoutConstraints key = element.getConstraints();</span>
<span class="nc bnc" id="L1098" title="All 2 branches missed.">            if (key.gridy == point.y) {</span>
<span class="nc" id="L1099">              int height = element.getOriginalBound().height - dy;</span>
<span class="nc" id="L1100">              Dimension min = element.getComponent().getMinimumSize();</span>
<span class="nc bnc" id="L1101" title="All 2 branches missed.">              int minsize = min == null ? 50 : min.height;</span>
<span class="nc bnc" id="L1102" title="All 2 branches missed.">              if (height &lt; minsize) {</span>
<span class="nc" id="L1103">                limitdy = dy - (minsize - height);</span>
              }
<span class="nc bnc" id="L1105" title="All 2 branches missed.">            } else if (key.gridy + key.gridheight == point.y) {</span>
<span class="nc" id="L1106">              int height = element.getOriginalBound().height + dy;</span>
<span class="nc" id="L1107">              Dimension min = element.getComponent().getMinimumSize();</span>
<span class="nc bnc" id="L1108" title="All 2 branches missed.">              int minsize = min == null ? 50 : min.height;</span>
<span class="nc bnc" id="L1109" title="All 2 branches missed.">              if (height &lt; minsize) {</span>
<span class="nc" id="L1110">                limitdy = dy + (minsize - height);</span>
              }
            }
<span class="nc" id="L1113">          }</span>
<span class="nc bnc" id="L1114" title="All 2 branches missed.">          for (DragLayoutElement element : list) {</span>
<span class="nc" id="L1115">            LayoutConstraints key = element.getConstraints();</span>
<span class="nc" id="L1116">            LayoutConstraints originkey = element.getOriginalConstraints();</span>
<span class="nc bnc" id="L1117" title="All 2 branches missed.">            if (key.gridy == point.y) {</span>
<span class="nc" id="L1118">              key.weighty =</span>
                  originkey.weighty
<span class="nc" id="L1120">                      - limitdy * originkey.weighty / element.getOriginalBound().height;</span>
<span class="nc bnc" id="L1121" title="All 2 branches missed.">            } else if (key.gridy + key.gridheight == point.y) {</span>
<span class="nc" id="L1122">              key.weighty =</span>
                  originkey.weighty
<span class="nc" id="L1124">                      + limitdy * originkey.weighty / element.getOriginalBound().height;</span>
            }
<span class="nc" id="L1126">          }</span>
        }
<span class="nc" id="L1128">        Rectangle b = grid.getBounds();</span>
<span class="nc" id="L1129">        double totalWidth = b.getWidth();</span>
<span class="nc" id="L1130">        double totalHeight = b.getHeight();</span>
<span class="nc" id="L1131">        grid.removeAll();</span>
<span class="nc bnc" id="L1132" title="All 2 branches missed.">        for (DragLayoutElement element : list) {</span>
<span class="nc" id="L1133">          Component c = element.getComponent();</span>
<span class="nc" id="L1134">          LayoutConstraints l = element.getConstraints();</span>
<span class="nc" id="L1135">          c.setPreferredSize(</span>
              new Dimension(
<span class="nc" id="L1137">                  (int) Math.round(totalWidth * l.weightx),</span>
<span class="nc" id="L1138">                  (int) Math.round(totalHeight * l.weighty)));</span>
<span class="nc" id="L1139">          grid.add(c, l);</span>
<span class="nc" id="L1140">        }</span>
<span class="nc" id="L1141">        setCursor(</span>
<span class="nc" id="L1142">            Cursor.getPredefinedCursor(</span>
<span class="nc bnc" id="L1143" title="All 2 branches missed.">                splitVertical ? Cursor.E_RESIZE_CURSOR : Cursor.S_RESIZE_CURSOR));</span>
<span class="nc" id="L1144">        grid.revalidate();</span>
<span class="nc" id="L1145">        grid.repaint();</span>
      }
<span class="nc" id="L1147">    }</span>

    @Override
    public void mouseMoved(MouseEvent me) {
<span class="nc" id="L1151">      setCursor(Cursor.getPredefinedCursor(getCursor(me)));</span>
<span class="nc" id="L1152">    }</span>

    @Override
    public void mouseExited(MouseEvent mouseEvent) {
<span class="nc" id="L1156">      setCursor(Cursor.getDefaultCursor());</span>
<span class="nc" id="L1157">    }</span>

    private int getCursor(MouseEvent me) {
<span class="nc" id="L1160">      Point p = me.getPoint();</span>
      for (Entry&lt;LayoutConstraints, Component&gt; entry :
<span class="nc bnc" id="L1162" title="All 2 branches missed.">          ImageViewerPlugin.this.layoutModel.getConstraints().entrySet()) {</span>
<span class="nc" id="L1163">        Component c = entry.getValue();</span>
<span class="nc bnc" id="L1164" title="All 2 branches missed.">        if (c != null) {</span>
<span class="nc" id="L1165">          Rectangle rect = c.getBounds();</span>
<span class="nc bnc" id="L1166" title="All 2 branches missed.">          if ((Math.abs(rect.x - p.x) &lt;= LayoutConstraints.SPACE</span>
<span class="nc bnc" id="L1167" title="All 6 branches missed.">                  || Math.abs(rect.x + rect.width - p.x) &lt;= LayoutConstraints.SPACE)</span>
              &amp;&amp; (p.y &gt;= rect.y &amp;&amp; p.y &lt;= rect.y + rect.height)) {
<span class="nc" id="L1169">            return Cursor.E_RESIZE_CURSOR;</span>
<span class="nc bnc" id="L1170" title="All 2 branches missed.">          } else if ((Math.abs(rect.y - p.y) &lt;= LayoutConstraints.SPACE</span>
<span class="nc bnc" id="L1171" title="All 6 branches missed.">                  || Math.abs(rect.y + rect.height - p.y) &lt;= LayoutConstraints.SPACE)</span>
              &amp;&amp; (p.x &gt;= rect.x &amp;&amp; p.x &lt;= rect.x + rect.width)) {
<span class="nc" id="L1173">            return Cursor.S_RESIZE_CURSOR;</span>
          }
        }
<span class="nc" id="L1176">      }</span>
<span class="nc" id="L1177">      return Cursor.DEFAULT_CURSOR;</span>
    }
  }

  static class DragLayoutElement {
    private final LayoutConstraints originalConstraints;
    private final Rectangle originalBound;
    private final LayoutConstraints constraints;
    private final Component component;

<span class="nc" id="L1187">    public DragLayoutElement(LayoutConstraints constraints, Component component) {</span>
<span class="nc bnc" id="L1188" title="All 4 branches missed.">      if (constraints == null || component == null) {</span>
<span class="nc" id="L1189">        throw new IllegalArgumentException(&quot;Arguments cannot be null&quot;);</span>
      }
<span class="nc" id="L1191">      this.constraints = constraints;</span>
<span class="nc" id="L1192">      this.originalConstraints = constraints.copy();</span>
<span class="nc" id="L1193">      this.component = component;</span>
<span class="nc" id="L1194">      this.originalBound = component.getBounds();</span>
<span class="nc" id="L1195">    }</span>

    public LayoutConstraints getOriginalConstraints() {
<span class="nc" id="L1198">      return originalConstraints;</span>
    }

    public Rectangle getOriginalBound() {
<span class="nc" id="L1202">      return originalBound;</span>
    }

    public LayoutConstraints getConstraints() {
<span class="nc" id="L1206">      return constraints;</span>
    }

    public Component getComponent() {
<span class="nc" id="L1210">      return component;</span>
    }
  }

  public void selectLayoutPositionForAddingSeries(List&lt;MediaSeries&lt;E&gt;&gt; seriesList) {
<span class="nc" id="L1215">    int nbSeriesToAdd = 1;</span>
<span class="nc bnc" id="L1216" title="All 2 branches missed.">    if (seriesList != null) {</span>
<span class="nc" id="L1217">      nbSeriesToAdd = seriesList.size();</span>
<span class="nc bnc" id="L1218" title="All 2 branches missed.">      if (nbSeriesToAdd &lt; 1) {</span>
<span class="nc" id="L1219">        nbSeriesToAdd = 1;</span>
      }
    }
<span class="nc" id="L1222">    int pos = view2ds.size() - nbSeriesToAdd;</span>
<span class="nc bnc" id="L1223" title="All 2 branches missed.">    if (pos &lt; 0) {</span>
<span class="nc" id="L1224">      pos = 0;</span>
    }
<span class="nc" id="L1226">    setSelectedImagePane(view2ds.get(pos));</span>
<span class="nc" id="L1227">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>