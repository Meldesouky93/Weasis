<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>ImageViewerEventManager.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Tests</a> &gt; <a href="../index.html" class="el_bundle">weasis-core</a> &gt; <a href="index.source.html" class="el_package">org.weasis.core.ui.editor.image</a> &gt; <span class="el_source">ImageViewerEventManager.java</span></div><h1>ImageViewerEventManager.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2009-2020 Weasis Team and other contributors.
 *
 * This program and the accompanying materials are made available under the terms of the Eclipse
 * Public License 2.0 which is available at https://www.eclipse.org/legal/epl-2.0, or the Apache
 * License, Version 2.0 which is available at https://www.apache.org/licenses/LICENSE-2.0.
 *
 * SPDX-License-Identifier: EPL-2.0 OR Apache-2.0
 */
package org.weasis.core.ui.editor.image;

import java.awt.event.InputEvent;
import java.awt.event.KeyEvent;
import java.awt.event.KeyListener;
import java.awt.event.MouseWheelEvent;
import java.awt.geom.Point2D;
import java.beans.PropertyChangeListener;
import java.util.ArrayList;
import java.util.Collection;
import java.util.HashMap;
import java.util.List;
import java.util.Objects;
import java.util.Optional;
import javax.swing.BoundedRangeModel;
import javax.swing.SwingUtilities;
import javax.swing.event.SwingPropertyChangeSupport;
import org.weasis.core.Messages;
import org.weasis.core.api.gui.util.ActionState;
import org.weasis.core.api.gui.util.ActionW;
import org.weasis.core.api.gui.util.ComboItemListener;
import org.weasis.core.api.gui.util.DecFormatter;
import org.weasis.core.api.gui.util.Feature;
import org.weasis.core.api.gui.util.Filter;
import org.weasis.core.api.gui.util.SliderChangeListener;
import org.weasis.core.api.gui.util.SliderCineListener;
import org.weasis.core.api.gui.util.SliderCineListener.TIME;
import org.weasis.core.api.gui.util.ToggleButtonListener;
import org.weasis.core.api.image.GridBagLayoutModel;
import org.weasis.core.api.image.util.Unit;
import org.weasis.core.api.media.data.ImageElement;
import org.weasis.core.api.media.data.MediaSeries;
import org.weasis.core.api.media.data.Series;
import org.weasis.core.api.service.WProperties;
import org.weasis.core.ui.editor.SeriesViewerEvent;
import org.weasis.core.ui.editor.SeriesViewerEvent.EVENT;
import org.weasis.core.ui.editor.SeriesViewerListener;
import org.weasis.core.ui.editor.image.SynchData.Mode;
import org.weasis.core.ui.editor.image.dockable.MeasureTool;
import org.weasis.core.ui.launcher.Launcher;
import org.weasis.core.ui.model.graphic.Graphic;
import org.weasis.core.ui.model.utils.bean.PanPoint;
import org.weasis.core.ui.model.utils.imp.DefaultViewModel;
import org.weasis.core.ui.pref.ZoomSetting;
import org.weasis.core.ui.util.ColorLayerUI;
import org.weasis.core.ui.util.PrintDialog;

public abstract class ImageViewerEventManager&lt;E extends ImageElement&gt; implements KeyListener {
  public static final int WINDOW_SMALLEST = 0;
  public static final int WINDOW_LARGEST = 4096;
  public static final int WINDOW_DEFAULT = 700;
  public static final int LEVEL_SMALLEST = 0;
  public static final int LEVEL_LARGEST = 4096;
  public static final int LEVEL_DEFAULT = 300;

<span class="nc" id="L65">  protected final ArrayList&lt;SeriesViewerListener&gt; seriesViewerListeners = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L66">  protected final MouseActions mouseActions = new MouseActions(null);</span>
<span class="nc" id="L67">  protected final ZoomSetting zoomSetting = new ZoomSetting();</span>
<span class="nc" id="L68">  protected final WProperties options = new WProperties();</span>
  // Manages all PropertyChangeListeners in EDT
<span class="nc" id="L70">  protected final SwingPropertyChangeSupport propertySupport = new SwingPropertyChangeSupport(this);</span>
<span class="nc" id="L71">  protected final HashMap&lt;Feature&lt;? extends ActionState&gt;, ActionState&gt; actions = new HashMap&lt;&gt;();</span>

<span class="nc" id="L73">  protected volatile boolean enabledAction = true;</span>
  protected ImageViewerPlugin&lt;E&gt; selectedView2dContainer;

  protected ImageViewerEventManager() {
<span class="nc" id="L77">    super();</span>
<span class="nc" id="L78">  }</span>

  public void setAction(ActionState action) {
<span class="nc" id="L81">    actions.put(action.getActionW(), action);</span>
<span class="nc" id="L82">  }</span>

  public void removeAction(Feature&lt;?&gt; action) {
<span class="nc" id="L85">    actions.remove(action);</span>
<span class="nc" id="L86">  }</span>

  protected SliderCineListener getMoveTroughSliceAction(
      double speed, final TIME time, double mouseSensitivity) {
<span class="nc" id="L90">    return new SliderCineListener(ActionW.SCROLL_SERIES, 1, 2, 1, speed, time, mouseSensitivity) {</span>

      @Override
      public void stateChanged(BoundedRangeModel model) {

<span class="nc" id="L95">        ViewCanvas&lt;ImageElement&gt; view2d = null;</span>
<span class="nc" id="L96">        Series&lt;ImageElement&gt; series = null;</span>
<span class="nc" id="L97">        SynchCineEvent mediaEvent = null;</span>
<span class="nc" id="L98">        ImageElement image = null;</span>

<span class="nc bnc" id="L100" title="All 2 branches missed.">        if (selectedView2dContainer != null) {</span>
<span class="nc" id="L101">          view2d = (ViewCanvas&lt;ImageElement&gt;) selectedView2dContainer.getSelectedImagePane();</span>
        }

<span class="nc bnc" id="L104" title="All 4 branches missed.">        if (view2d != null &amp;&amp; view2d.getSeries() instanceof Series) {</span>
<span class="nc" id="L105">          series = (Series&lt;ImageElement&gt;) view2d.getSeries();</span>
<span class="nc bnc" id="L106" title="All 2 branches missed.">          if (series != null) {</span>
            // Model contains display value, value-1 is the index value of a sequence
<span class="nc" id="L108">            int index = model.getValue() - 1;</span>
<span class="nc" id="L109">            image =</span>
<span class="nc" id="L110">                series.getMedia(</span>
                    index,
<span class="nc" id="L112">                    (Filter&lt;ImageElement&gt;) view2d.getActionValue(ActionW.FILTERED_SERIES.cmd()),</span>
<span class="nc" id="L113">                    view2d.getCurrentSortComparator());</span>
<span class="nc" id="L114">            mediaEvent = new SynchCineEvent(view2d, image, index);</span>
            // Ensure to load image before calling the default preset (requires pixel min and max)
<span class="nc bnc" id="L116" title="All 4 branches missed.">            if (image != null &amp;&amp; !image.isImageAvailable()) {</span>
<span class="nc" id="L117">              image.getImage();</span>
            }
          }
        }

<span class="nc" id="L122">        firePropertyChange(ActionW.SYNCH.cmd(), null, mediaEvent);</span>
<span class="nc bnc" id="L123" title="All 2 branches missed.">        if (image != null) {</span>
<span class="nc" id="L124">          fireSeriesViewerListeners(</span>
              new SeriesViewerEvent(selectedView2dContainer, series, image, EVENT.SELECT));
        }
<span class="nc" id="L127">      }</span>

      @Override
      public void mouseWheelMoved(MouseWheelEvent e) {
<span class="nc" id="L131">        setSliderValue(getSliderValue() + e.getWheelRotation());</span>
<span class="nc" id="L132">      }</span>
    };
  }

  protected ToggleButtonListener newLoopSweepAction() {
<span class="nc" id="L137">    return new ToggleButtonListener(ActionW.CINE_SWEEP, false) {</span>

      @Override
      public void actionPerformed(boolean selected) {
<span class="nc" id="L141">        getAction(ActionW.SCROLL_SERIES).ifPresent(a -&gt; a.setSweeping(selected));</span>
<span class="nc" id="L142">      }</span>
    };
  }

  protected SliderChangeListener newWindowAction() {

<span class="nc" id="L148">    return new SliderChangeListener(</span>
<span class="nc" id="L149">        ActionW.WINDOW, WINDOW_SMALLEST, WINDOW_LARGEST, WINDOW_DEFAULT, true, 1.25) {</span>

      @Override
      public void stateChanged(BoundedRangeModel model) {
<span class="nc" id="L153">        firePropertyChange(</span>
<span class="nc" id="L154">            ActionW.SYNCH.cmd(),</span>
            null,
            new SynchEvent(
<span class="nc" id="L157">                getSelectedViewPane(), getActionW().cmd(), toModelValue(model.getValue())));</span>
<span class="nc bnc" id="L158" title="All 2 branches missed.">        if (selectedView2dContainer != null) {</span>
<span class="nc" id="L159">          fireSeriesViewerListeners(</span>
              new SeriesViewerEvent(selectedView2dContainer, null, null, EVENT.WIN_LEVEL));
        }
<span class="nc" id="L162">      }</span>
    };
  }

  protected SliderChangeListener newLevelAction() {
<span class="nc" id="L167">    return new SliderChangeListener(</span>
<span class="nc" id="L168">        ActionW.LEVEL, LEVEL_SMALLEST, LEVEL_LARGEST, LEVEL_DEFAULT, true, 1.25) {</span>

      @Override
      public void stateChanged(BoundedRangeModel model) {
<span class="nc" id="L172">        firePropertyChange(</span>
<span class="nc" id="L173">            ActionW.SYNCH.cmd(),</span>
            null,
            new SynchEvent(
<span class="nc" id="L176">                getSelectedViewPane(), getActionW().cmd(), toModelValue(model.getValue())));</span>
<span class="nc bnc" id="L177" title="All 2 branches missed.">        if (selectedView2dContainer != null) {</span>
<span class="nc" id="L178">          fireSeriesViewerListeners(</span>
              new SeriesViewerEvent(selectedView2dContainer, null, null, EVENT.WIN_LEVEL));
        }
<span class="nc" id="L181">      }</span>
    };
  }

  protected SliderChangeListener newRotateAction() {
<span class="nc" id="L186">    return new SliderChangeListener(ActionW.ROTATION, 0, 360, 0, true, 0.25) {</span>

      @Override
      public void stateChanged(BoundedRangeModel model) {
<span class="nc" id="L190">        firePropertyChange(</span>
<span class="nc" id="L191">            ActionW.SYNCH.cmd(),</span>
            null,
<span class="nc" id="L193">            new SynchEvent(getSelectedViewPane(), getActionW().cmd(), model.getValue()));</span>
<span class="nc" id="L194">      }</span>

      @Override
      public String getValueToDisplay() {
<span class="nc" id="L198">        return getSliderValue() + &quot; °&quot;;</span>
      }
    };
  }

  protected SliderChangeListener newZoomAction() {

<span class="nc" id="L205">    return new SliderChangeListener(</span>
<span class="nc" id="L206">        ActionW.ZOOM, DefaultViewModel.SCALE_MIN, DefaultViewModel.SCALE_MAX, 1.0, true, 0.3, 300) {</span>

      @Override
      public void stateChanged(BoundedRangeModel model) {
<span class="nc" id="L210">        firePropertyChange(</span>
<span class="nc" id="L211">            ActionW.SYNCH.cmd(),</span>
            null,
            new SynchEvent(
<span class="nc" id="L214">                getSelectedViewPane(), getActionW().cmd(), toModelValue(model.getValue())));</span>
<span class="nc" id="L215">      }</span>

      @Override
      public String getValueToDisplay() {
<span class="nc" id="L219">        return DecFormatter.percentTwoDecimal(getRealValue());</span>
      }

      @Override
      public int toSliderValue(double viewScale) {
<span class="nc" id="L224">        double v = Math.log(viewScale) / Math.log(DefaultViewModel.SCALE_MAX) * getSliderMax();</span>
<span class="nc" id="L225">        return (int) Math.round(v);</span>
      }

      @Override
      public double toModelValue(int sliderValue) {
<span class="nc" id="L230">        double v = sliderValue / (double) getSliderMax();</span>
<span class="nc" id="L231">        double viewScale = Math.exp(v * Math.log(DefaultViewModel.SCALE_MAX));</span>
<span class="nc" id="L232">        return roundAndCropViewScale(</span>
            viewScale, DefaultViewModel.SCALE_MIN, DefaultViewModel.SCALE_MAX);
      }
    };
  }

  protected PannerListener newPanAction() {
<span class="nc" id="L239">    return new PannerListener(ActionW.PAN, null) {</span>

      @Override
      public void pointChanged(Point2D point) {
<span class="nc" id="L243">        firePropertyChange(</span>
<span class="nc" id="L244">            ActionW.SYNCH.cmd(),</span>
            null,
<span class="nc" id="L246">            new SynchEvent(getSelectedViewPane(), getActionW().cmd(), point));</span>
<span class="nc" id="L247">      }</span>
    };
  }

  protected CrosshairListener newCrosshairAction() {
<span class="nc" id="L252">    return new CrosshairListener(ActionW.CROSSHAIR, null) {</span>

      @Override
      public void pointChanged(PanPoint point) {
<span class="nc" id="L256">        firePropertyChange(</span>
<span class="nc" id="L257">            ActionW.SYNCH.cmd(),</span>
            null,
<span class="nc" id="L259">            new SynchEvent(getSelectedViewPane(), getActionW().cmd(), point));</span>
<span class="nc" id="L260">      }</span>
    };
  }

  protected ToggleButtonListener newFlipAction() {
<span class="nc" id="L265">    return new ToggleButtonListener(ActionW.FLIP, false) {</span>

      @Override
      public void actionPerformed(boolean selected) {
<span class="nc" id="L269">        firePropertyChange(</span>
<span class="nc" id="L270">            ActionW.SYNCH.cmd(),</span>
            null,
<span class="nc" id="L272">            new SynchEvent(getSelectedViewPane(), action.cmd(), selected));</span>
<span class="nc" id="L273">      }</span>
    };
  }

  protected ToggleButtonListener newInverseLutAction() {
<span class="nc" id="L278">    return new ToggleButtonListener(ActionW.INVERT_LUT, false) {</span>

      @Override
      public void actionPerformed(boolean selected) {
<span class="nc" id="L282">        firePropertyChange(</span>
<span class="nc" id="L283">            ActionW.SYNCH.cmd(),</span>
            null,
<span class="nc" id="L285">            new SynchEvent(getSelectedViewPane(), action.cmd(), selected));</span>
<span class="nc bnc" id="L286" title="All 2 branches missed.">        if (selectedView2dContainer != null) {</span>
<span class="nc" id="L287">          fireSeriesViewerListeners(</span>
              new SeriesViewerEvent(selectedView2dContainer, null, null, EVENT.LUT));
        }
<span class="nc" id="L290">      }</span>
    };
  }

  protected ToggleButtonListener newLensAction() {
<span class="nc" id="L295">    return new ToggleButtonListener(ActionW.LENS, false) {</span>

      @Override
      public void actionPerformed(boolean selected) {
<span class="nc" id="L299">        firePropertyChange(</span>
<span class="nc" id="L300">            ActionW.SYNCH.cmd(),</span>
            null,
<span class="nc" id="L302">            new SynchEvent(getSelectedViewPane(), action.cmd(), selected));</span>
<span class="nc" id="L303">      }</span>
    };
  }

  protected SliderChangeListener newLensZoomAction() {
<span class="nc" id="L308">    return new SliderChangeListener(</span>
        ActionW.LENS_ZOOM,
        DefaultViewModel.SCALE_MIN,
        DefaultViewModel.SCALE_MAX,
        2.0,
        true,
        0.3,
<span class="nc" id="L315">        300) {</span>

      @Override
      public void stateChanged(BoundedRangeModel model) {
<span class="nc" id="L319">        firePropertyChange(</span>
<span class="nc" id="L320">            ActionW.SYNCH.cmd(),</span>
            null,
            new SynchEvent(
<span class="nc" id="L323">                getSelectedViewPane(), getActionW().cmd(), toModelValue(model.getValue())));</span>
<span class="nc" id="L324">      }</span>

      @Override
      public String getValueToDisplay() {
<span class="nc" id="L328">        return DecFormatter.percentTwoDecimal(getRealValue());</span>
      }

      @Override
      public int toSliderValue(double viewScale) {
<span class="nc" id="L333">        double v = Math.log(viewScale) / Math.log(DefaultViewModel.SCALE_MAX) * getSliderMax();</span>
<span class="nc" id="L334">        return (int) Math.round(v);</span>
      }

      @Override
      public double toModelValue(int sliderValue) {
<span class="nc" id="L339">        double v = sliderValue / (double) getSliderMax();</span>
<span class="nc" id="L340">        double viewScale = Math.exp(v * Math.log(DefaultViewModel.SCALE_MAX));</span>
<span class="nc" id="L341">        return roundAndCropViewScale(</span>
            viewScale, DefaultViewModel.SCALE_MIN, DefaultViewModel.SCALE_MAX);
      }
    };
  }

  protected ComboItemListener&lt;GridBagLayoutModel&gt; newLayoutAction(GridBagLayoutModel[] layouts) {
<span class="nc" id="L348">    return new ComboItemListener&lt;&gt;(</span>
<span class="nc" id="L349">        ActionW.LAYOUT, Optional.ofNullable(layouts).orElseGet(() -&gt; new GridBagLayoutModel[0])) {</span>

      @Override
      public void itemStateChanged(Object object) {
<span class="nc bnc" id="L353" title="All 4 branches missed.">        if (selectedView2dContainer != null</span>
<span class="nc" id="L354">            &amp;&amp; object instanceof GridBagLayoutModel gridBagLayoutModel) {</span>
          // change layout
<span class="nc" id="L356">          clearAllPropertyChangeListeners();</span>
<span class="nc" id="L357">          ViewCanvas&lt;E&gt; view = selectedView2dContainer.getSelectedImagePane();</span>
<span class="nc" id="L358">          selectedView2dContainer.setLayoutModel(gridBagLayoutModel);</span>
<span class="nc bnc" id="L359" title="All 2 branches missed.">          if (!selectedView2dContainer.isContainingView(view)) {</span>
<span class="nc" id="L360">            view = selectedView2dContainer.getSelectedImagePane();</span>
          }
<span class="nc" id="L362">          selectedView2dContainer.setSelectedImagePane(view);</span>
<span class="nc" id="L363">          getAction(ActionW.SYNCH)</span>
<span class="nc" id="L364">              .ifPresent(</span>
<span class="nc" id="L365">                  s -&gt; selectedView2dContainer.setSynchView((SynchView) s.getSelectedItem()));</span>
        }
<span class="nc" id="L367">      }</span>
    };
  }

  protected ComboItemListener&lt;SynchView&gt; newSynchAction(SynchView[] synchViewList) {
<span class="nc" id="L372">    return new ComboItemListener&lt;&gt;(</span>
<span class="nc" id="L373">        ActionW.SYNCH, Optional.ofNullable(synchViewList).orElseGet(() -&gt; new SynchView[0])) {</span>

      @Override
      public void itemStateChanged(Object object) {
<span class="nc bnc" id="L377" title="All 4 branches missed.">        if (object instanceof SynchView synchView &amp;&amp; selectedView2dContainer != null) {</span>
<span class="nc" id="L378">          selectedView2dContainer.setSynchView(synchView);</span>
        }
<span class="nc" id="L380">      }</span>
    };
  }

  protected ToggleButtonListener newInverseStackAction() {
<span class="nc" id="L385">    return new ToggleButtonListener(ActionW.INVERSE_STACK, false) {</span>

      @Override
      public void actionPerformed(boolean selected) {
<span class="nc" id="L389">        firePropertyChange(</span>
<span class="nc" id="L390">            ActionW.SYNCH.cmd(),</span>
            null,
<span class="nc" id="L392">            new SynchEvent(getSelectedViewPane(), action.cmd(), selected));</span>
<span class="nc" id="L393">      }</span>
    };
  }

  protected static ComboItemListener&lt;Graphic&gt; newMeasurementAction(Graphic[] graphics) {
<span class="nc" id="L398">    return new ComboItemListener&lt;&gt;(</span>
<span class="nc" id="L399">        ActionW.DRAW_MEASURE, Optional.ofNullable(graphics).orElseGet(() -&gt; new Graphic[0])) {</span>

      @Override
      public void itemStateChanged(Object object) {
        // Do nothing
<span class="nc" id="L404">      }</span>
    };
  }

  protected static ComboItemListener&lt;Graphic&gt; newDrawAction(Graphic[] graphics) {
<span class="nc" id="L409">    return new ComboItemListener&lt;&gt;(</span>
<span class="nc" id="L410">        ActionW.DRAW_GRAPHICS, Optional.ofNullable(graphics).orElseGet(() -&gt; new Graphic[0])) {</span>

      @Override
      public void itemStateChanged(Object object) {
        // Do nothing
<span class="nc" id="L415">      }</span>
    };
  }

  protected ToggleButtonListener newDrawOnlyOnceAction() {
<span class="nc" id="L420">    return new ToggleButtonListener(ActionW.DRAW_ONLY_ONCE, true) {</span>

      @Override
      public void actionPerformed(boolean selected) {
<span class="nc" id="L424">        firePropertyChange(</span>
<span class="nc" id="L425">            ActionW.SYNCH.cmd(),</span>
            null,
<span class="nc" id="L427">            new SynchEvent(getSelectedViewPane(), action.cmd(), selected));</span>
<span class="nc" id="L428">        MeasureTool.viewSetting.setDrawOnlyOnce(selected);</span>
<span class="nc" id="L429">      }</span>
    };
  }

  protected ComboItemListener&lt;Unit&gt; newSpatialUnit(Unit[] units) {
<span class="nc" id="L434">    return new ComboItemListener&lt;&gt;(</span>
<span class="nc" id="L435">        ActionW.SPATIAL_UNIT, Optional.ofNullable(units).orElseGet(() -&gt; new Unit[0])) {</span>

      @Override
      public void itemStateChanged(Object object) {
<span class="nc" id="L439">        firePropertyChange(</span>
<span class="nc" id="L440">            ActionW.SYNCH.cmd(), null, new SynchEvent(getSelectedViewPane(), action.cmd(), object));</span>
<span class="nc" id="L441">      }</span>
    };
  }

  public abstract boolean updateComponentsListener(ViewCanvas&lt;E&gt; viewCanvas);

  public static double roundAndCropViewScale(
      double viewScale, double minViewScale, double maxViewScale) {
<span class="nc" id="L449">    double ratio = viewScale;</span>
<span class="nc" id="L450">    ratio *= 1000.0;</span>
<span class="nc" id="L451">    double v = Math.floor(ratio);</span>
<span class="nc bnc" id="L452" title="All 2 branches missed.">    if (ratio - v &gt;= 0.5) {</span>
<span class="nc" id="L453">      v += 0.5;</span>
    }
<span class="nc" id="L455">    ratio = v / 1000.0;</span>
<span class="nc bnc" id="L456" title="All 2 branches missed.">    if (ratio &lt; minViewScale) {</span>
<span class="nc" id="L457">      ratio = minViewScale;</span>
    }
<span class="nc bnc" id="L459" title="All 2 branches missed.">    if (ratio &gt; maxViewScale) {</span>
<span class="nc" id="L460">      ratio = maxViewScale;</span>
    }
<span class="nc" id="L462">    return ratio;</span>
  }

  /** Fire property change event. */
  protected void firePropertyChange(String propertyName, Object oldValue, Object newValue) {
<span class="nc" id="L467">    propertySupport.firePropertyChange(propertyName, oldValue, newValue);</span>
<span class="nc" id="L468">  }</span>

  /** Add a property change listener. */
  public void addPropertyChangeListener(String propertyName, PropertyChangeListener listener) {
<span class="nc" id="L472">    propertySupport.addPropertyChangeListener(propertyName, listener);</span>
<span class="nc" id="L473">  }</span>

  /** Remove a property change listener. */
  public void removePropertyChangeListener(String propertyName, PropertyChangeListener listener) {
<span class="nc" id="L477">    propertySupport.removePropertyChangeListener(propertyName, listener);</span>
<span class="nc" id="L478">  }</span>

  public void addSeriesViewerListener(SeriesViewerListener listener) {
<span class="nc bnc" id="L481" title="All 2 branches missed.">    if (!seriesViewerListeners.contains(listener)) {</span>
<span class="nc" id="L482">      seriesViewerListeners.add(listener);</span>
    }
<span class="nc" id="L484">  }</span>

  /** Remove a property change listener. */
  public void removeSeriesViewerListener(SeriesViewerListener listener) {
<span class="nc" id="L488">    seriesViewerListeners.remove(listener);</span>
<span class="nc" id="L489">  }</span>

  public void fireSeriesViewerListeners(SeriesViewerEvent event) {
<span class="nc bnc" id="L492" title="All 2 branches missed.">    if (event != null) {</span>
<span class="nc bnc" id="L493" title="All 2 branches missed.">      for (SeriesViewerListener listener : seriesViewerListeners) {</span>
<span class="nc" id="L494">        listener.changingViewContentEvent(event);</span>
<span class="nc" id="L495">      }</span>
    }
<span class="nc" id="L497">  }</span>

  public void clearAllPropertyChangeListeners() {
<span class="nc" id="L500">    PropertyChangeListener[] changeListeners = propertySupport.getPropertyChangeListeners();</span>
<span class="nc bnc" id="L501" title="All 2 branches missed.">    for (PropertyChangeListener propertyChangeListener : changeListeners) {</span>
<span class="nc" id="L502">      propertySupport.removePropertyChangeListener(propertyChangeListener);</span>
    }
<span class="nc" id="L504">  }</span>

  public &lt;T&gt; Optional&lt;T&gt; getAction(Feature&lt;T&gt; feature) {
<span class="nc bnc" id="L507" title="All 2 branches missed.">    if (feature != null) {</span>
<span class="nc" id="L508">      return Optional.ofNullable((T) actions.get(feature));</span>
    }
<span class="nc" id="L510">    return Optional.empty();</span>
  }

  public boolean isActionRegistered(Feature&lt;?&gt; feature) {
<span class="nc bnc" id="L514" title="All 2 branches missed.">    if (feature != null) {</span>
<span class="nc" id="L515">      return actions.containsKey(feature);</span>
    }
<span class="nc" id="L517">    return false;</span>
  }

  public boolean isActionEnabled(Feature&lt;?&gt; feature) {
<span class="nc bnc" id="L521" title="All 2 branches missed.">    if (feature != null) {</span>
<span class="nc" id="L522">      ActionState action = actions.get(feature);</span>
<span class="nc bnc" id="L523" title="All 2 branches missed.">      if (action != null) {</span>
<span class="nc" id="L524">        return action.isActionEnabled();</span>
      }
    }
<span class="nc" id="L527">    return false;</span>
  }

  public Optional&lt;Feature&lt;? extends ActionState&gt;&gt; getActionKey(String command) {
<span class="nc bnc" id="L531" title="All 2 branches missed.">    if (command == null) {</span>
<span class="nc" id="L532">      return Optional.empty();</span>
    }
<span class="nc" id="L534">    return actions.keySet().stream().filter(k -&gt; k.cmd().equals(command)).findFirst();</span>
  }

  public &lt;T&gt; Optional&lt;T&gt; getActionFromActionKey(String command, Class&lt;T&gt; type) {
<span class="nc bnc" id="L538" title="All 2 branches missed.">    if (command == null) {</span>
<span class="nc" id="L539">      return Optional.empty();</span>
    }
<span class="nc" id="L541">    Objects.requireNonNull(type);</span>

<span class="nc" id="L543">    return actions.keySet().stream()</span>
<span class="nc" id="L544">        .filter(k -&gt; k.cmd().equals(command))</span>
<span class="nc" id="L545">        .findFirst()</span>
<span class="nc" id="L546">        .map(actions::get)</span>
<span class="nc" id="L547">        .filter(type::isInstance)</span>
<span class="nc" id="L548">        .map(type::cast);</span>
  }

  public Optional&lt;Feature&lt;? extends ActionState&gt;&gt; getLeftMouseActionFromKeyEvent(
      int keyEvent, int modifier) {
<span class="nc bnc" id="L553" title="All 2 branches missed.">    if (keyEvent == 0) {</span>
<span class="nc" id="L554">      return Optional.empty();</span>
    }
<span class="nc" id="L556">    return actions.keySet().stream()</span>
<span class="nc bnc" id="L557" title="All 6 branches missed.">        .filter(k -&gt; k != null &amp;&amp; k.getKeyCode() == keyEvent &amp;&amp; k.getModifier() == modifier)</span>
<span class="nc" id="L558">        .findFirst();</span>
  }

  public void changeLeftMouseAction(String command) {
<span class="nc" id="L562">    ImageViewerPlugin&lt;E&gt; view = getSelectedView2dContainer();</span>
<span class="nc bnc" id="L563" title="All 2 branches missed.">    if (view != null) {</span>
<span class="nc" id="L564">      ViewerToolBar&lt;E&gt; toolBar = view.getViewerToolBar();</span>
<span class="nc bnc" id="L565" title="All 2 branches missed.">      if (toolBar != null) {</span>
<span class="nc" id="L566">        MouseActions mActions = getMouseActions();</span>
<span class="nc bnc" id="L567" title="All 2 branches missed.">        if (!command.equals(mActions.getAction(MouseActions.T_LEFT))) {</span>
<span class="nc" id="L568">          mActions.setAction(MouseActions.T_LEFT, command);</span>
<span class="nc" id="L569">          view.setMouseActions(mActions);</span>
<span class="nc" id="L570">          toolBar.changeButtonState(MouseActions.T_LEFT, command);</span>
        }
      }
    }
<span class="nc" id="L574">  }</span>

  public void nextLeftMouseAction() {
<span class="nc" id="L577">    ImageViewerPlugin&lt;E&gt; view = getSelectedView2dContainer();</span>
<span class="nc bnc" id="L578" title="All 2 branches missed.">    if (view != null) {</span>
      @SuppressWarnings(&quot;unchecked&quot;)
<span class="nc" id="L580">      ViewerToolBar&lt;E&gt; toolBar = view.getViewerToolBar();</span>
<span class="nc bnc" id="L581" title="All 2 branches missed.">      if (toolBar != null) {</span>
<span class="nc" id="L582">        String command =</span>
<span class="nc" id="L583">            ViewerToolBar.getNextCommand(</span>
<span class="nc" id="L584">                    ViewerToolBar.actionsButtons, toolBar.getMouseLeft().getActionCommand())</span>
<span class="nc" id="L585">                .cmd();</span>
<span class="nc" id="L586">        changeLeftMouseAction(command);</span>
      }
    }
<span class="nc" id="L589">  }</span>

  public Optional&lt;Feature&lt;? extends ActionState&gt;&gt; getMouseAction(int modifiers) {
<span class="nc" id="L592">    Optional&lt;Feature&lt;? extends ActionState&gt;&gt; action = Optional.empty();</span>
    // left mouse button, always active
<span class="nc bnc" id="L594" title="All 2 branches missed.">    if ((modifiers &amp; InputEvent.BUTTON1_DOWN_MASK) != 0) {</span>
<span class="nc" id="L595">      action = getActionKey(mouseActions.getLeft());</span>
    }
    // middle mouse button
<span class="nc bnc" id="L598" title="All 2 branches missed.">    else if ((modifiers &amp; InputEvent.BUTTON2_DOWN_MASK) != 0</span>
<span class="nc bnc" id="L599" title="All 2 branches missed.">        &amp;&amp; ((mouseActions.getActiveButtons() &amp; InputEvent.BUTTON2_DOWN_MASK) != 0)) {</span>
<span class="nc" id="L600">      action = getActionKey(mouseActions.getMiddle());</span>
    }
    // right mouse button
<span class="nc bnc" id="L603" title="All 2 branches missed.">    else if ((modifiers &amp; InputEvent.BUTTON3_DOWN_MASK) != 0</span>
<span class="nc bnc" id="L604" title="All 2 branches missed.">        &amp;&amp; ((mouseActions.getActiveButtons() &amp; InputEvent.BUTTON3_DOWN_MASK) != 0)) {</span>
<span class="nc" id="L605">      action = getActionKey(mouseActions.getRight());</span>
    }
<span class="nc" id="L607">    return action;</span>
  }

  public Collection&lt;ActionState&gt; getAllActionValues() {
<span class="nc" id="L611">    return actions.values().stream().filter(Objects::nonNull).toList();</span>
  }

  public MouseActions getMouseActions() {
<span class="nc" id="L615">    return mouseActions;</span>
  }

  public ZoomSetting getZoomSetting() {
<span class="nc" id="L619">    return zoomSetting;</span>
  }

  public WProperties getOptions() {
<span class="nc" id="L623">    return options;</span>
  }

  public synchronized void enableActions(boolean enabled) {
<span class="nc" id="L627">    enabledAction = enabled;</span>
<span class="nc bnc" id="L628" title="All 2 branches missed.">    for (ActionState a : getAllActionValues()) {</span>
<span class="nc" id="L629">      a.enableAction(enabled);</span>
<span class="nc" id="L630">    }</span>
<span class="nc" id="L631">  }</span>

  public ViewCanvas&lt;E&gt; getSelectedViewPane() {
<span class="nc" id="L634">    ImageViewerPlugin&lt;E&gt; container = selectedView2dContainer;</span>
<span class="nc bnc" id="L635" title="All 2 branches missed.">    if (container != null) {</span>
<span class="nc" id="L636">      return container.getSelectedImagePane();</span>
    }
<span class="nc" id="L638">    return null;</span>
  }

  public ImageViewerPlugin&lt;E&gt; getSelectedView2dContainer() {
<span class="nc" id="L642">    return selectedView2dContainer;</span>
  }

  public boolean isSelectedView2dContainerInTileMode() {
<span class="nc" id="L646">    ImageViewerPlugin&lt;E&gt; container = selectedView2dContainer;</span>
<span class="nc bnc" id="L647" title="All 2 branches missed.">    if (container != null) {</span>
<span class="nc" id="L648">      return SynchData.Mode.TILE.equals(container.getSynchView().getSynchData().getMode());</span>
    }
<span class="nc" id="L650">    return false;</span>
  }

  public void updateAllListeners(ImageViewerPlugin&lt;E&gt; viewerPlugin, SynchView synchView) {
<span class="nc" id="L654">    clearAllPropertyChangeListeners();</span>
<span class="nc bnc" id="L655" title="All 2 branches missed.">    if (viewerPlugin != null) {</span>
<span class="nc" id="L656">      ViewCanvas&lt;E&gt; viewPane = viewerPlugin.getSelectedImagePane();</span>
<span class="nc bnc" id="L657" title="All 2 branches missed.">      if (viewPane == null) {</span>
<span class="nc" id="L658">        return;</span>
      }
<span class="nc bnc" id="L660" title="All 2 branches missed.">      if (viewPane.getSeries() != null) {</span>
<span class="nc" id="L661">        SynchData synch = synchView.getSynchData();</span>
<span class="nc" id="L662">        viewPane.setActionsInView(ActionW.SYNCH_LINK.cmd(), null);</span>
<span class="nc" id="L663">        addPropertyChangeListener(ActionW.SYNCH.cmd(), viewPane);</span>

<span class="nc" id="L665">        final List&lt;ViewCanvas&lt;E&gt;&gt; panes = viewerPlugin.getImagePanels();</span>
<span class="nc" id="L666">        panes.remove(viewPane);</span>
<span class="nc bnc" id="L667" title="All 2 branches missed.">        if (SynchView.NONE.equals(synchView)) {</span>
<span class="nc bnc" id="L668" title="All 2 branches missed.">          for (ViewCanvas&lt;E&gt; pane : panes) {</span>
<span class="nc" id="L669">            pane.setActionsInView(ActionW.SYNCH_LINK.cmd(), synch);</span>
<span class="nc" id="L670">          }</span>
<span class="nc bnc" id="L671" title="All 2 branches missed.">        } else if (Mode.STACK.equals(synch.getMode())) {</span>
          // TODO if Pan is activated than rotation is required
<span class="nc" id="L673">          boolean hasLink = false;</span>
<span class="nc bnc" id="L674" title="All 2 branches missed.">          for (ViewCanvas&lt;E&gt; pane : panes) {</span>
<span class="nc" id="L675">            boolean synchByDefault = isCompatible(viewPane.getSeries(), pane.getSeries());</span>
<span class="nc bnc" id="L676" title="All 2 branches missed.">            pane.setActionsInView(ActionW.SYNCH_LINK.cmd(), synchByDefault ? synch.copy() : null);</span>
<span class="nc bnc" id="L677" title="All 2 branches missed.">            if (synchByDefault) {</span>
<span class="nc" id="L678">              hasLink = true;</span>
<span class="nc" id="L679">              addPropertyChangeListener(ActionW.SYNCH.cmd(), pane);</span>
            }
<span class="nc" id="L681">          }</span>
<span class="nc bnc" id="L682" title="All 2 branches missed.">        } else if (Mode.TILE.equals(synch.getMode())) {</span>
<span class="nc bnc" id="L683" title="All 2 branches missed.">          for (ViewCanvas&lt;E&gt; pane : panes) {</span>
<span class="nc" id="L684">            pane.setActionsInView(ActionW.SYNCH_LINK.cmd(), synch.copy());</span>
<span class="nc" id="L685">            addPropertyChangeListener(ActionW.SYNCH.cmd(), pane);</span>
<span class="nc" id="L686">          }</span>
        }
      }
    }
<span class="nc" id="L690">  }</span>

  protected boolean commonDisplayShortcuts(KeyEvent e) {
<span class="nc" id="L693">    int keyEvent = e.getKeyCode();</span>
<span class="nc" id="L694">    int modifiers = e.getModifiers();</span>

<span class="nc bnc" id="L696" title="All 2 branches missed.">    if (keyEvent == KeyEvent.VK_ESCAPE) {</span>
<span class="nc" id="L697">      resetDisplay();</span>
<span class="nc bnc" id="L698" title="All 2 branches missed.">    } else if (keyEvent == ActionW.CINESTART.getKeyCode()</span>
<span class="nc bnc" id="L699" title="All 2 branches missed.">        &amp;&amp; ActionW.CINESTART.getModifier() == modifiers) {</span>
<span class="nc" id="L700">      Optional&lt;SliderCineListener&gt; cineAction = getAction(ActionW.SCROLL_SERIES);</span>
<span class="nc bnc" id="L701" title="All 4 branches missed.">      if (cineAction.isPresent() &amp;&amp; cineAction.get().isActionEnabled()) {</span>
<span class="nc bnc" id="L702" title="All 2 branches missed.">        if (cineAction.get().isCining()) {</span>
<span class="nc" id="L703">          cineAction.get().stop();</span>
        } else {
<span class="nc" id="L705">          cineAction.get().start();</span>
        }
      }
<span class="nc bnc" id="L708" title="All 4 branches missed.">    } else if (keyEvent == KeyEvent.VK_P &amp;&amp; modifiers == 0) {</span>
<span class="nc" id="L709">      ImageViewerPlugin&lt;? extends ImageElement&gt; view = getSelectedView2dContainer();</span>
<span class="nc bnc" id="L710" title="All 2 branches missed.">      if (view != null) {</span>
<span class="nc" id="L711">        ColorLayerUI layer = ColorLayerUI.createTransparentLayerUI(view);</span>
<span class="nc" id="L712">        PrintDialog&lt;?&gt; dialog =</span>
            new PrintDialog&lt;&gt;(
<span class="nc" id="L714">                SwingUtilities.getWindowAncestor(view),</span>
<span class="nc" id="L715">                Messages.getString(&quot;ImageViewerPlugin.print_layout&quot;),</span>
                this);
<span class="nc" id="L717">        ColorLayerUI.showCenterScreen(dialog, layer);</span>
      }
<span class="nc bnc" id="L719" title="All 6 branches missed.">    } else if (keyEvent == KeyEvent.VK_UP &amp;&amp; !e.isAltDown() &amp;&amp; !e.isControlDown()) {</span>
<span class="nc bnc" id="L720" title="All 2 branches missed.">      int shift = e.isShiftDown() ? 10 : 1;</span>
<span class="nc" id="L721">      getAction(ActionW.SCROLL_SERIES).ifPresent(a -&gt; a.setSliderValue(a.getSliderValue() - shift));</span>
<span class="nc bnc" id="L722" title="All 6 branches missed.">    } else if (keyEvent == KeyEvent.VK_DOWN &amp;&amp; !e.isAltDown() &amp;&amp; !e.isControlDown()) {</span>
<span class="nc bnc" id="L723" title="All 2 branches missed.">      int shift = e.isShiftDown() ? 10 : 1;</span>
<span class="nc" id="L724">      getAction(ActionW.SCROLL_SERIES).ifPresent(a -&gt; a.setSliderValue(a.getSliderValue() + shift));</span>
<span class="nc bnc" id="L725" title="All 4 branches missed.">    } else if (keyEvent == KeyEvent.VK_HOME &amp;&amp; !e.isControlDown()) {</span>
<span class="nc" id="L726">      getAction(ActionW.SCROLL_SERIES).ifPresent(a -&gt; a.setSliderValue(a.getSliderMin()));</span>
<span class="nc bnc" id="L727" title="All 4 branches missed.">    } else if (keyEvent == KeyEvent.VK_END &amp;&amp; !e.isControlDown()) {</span>
<span class="nc" id="L728">      getAction(ActionW.SCROLL_SERIES).ifPresent(a -&gt; a.setSliderValue(a.getSliderMax()));</span>
<span class="nc bnc" id="L729" title="All 4 branches missed.">    } else if (keyEvent == KeyEvent.VK_SUBTRACT &amp;&amp; e.isControlDown()) {</span>
<span class="nc" id="L730">      getAction(ActionW.ZOOM).ifPresent(a -&gt; a.setSliderValue(a.getSliderValue() - 1));</span>
<span class="nc bnc" id="L731" title="All 4 branches missed.">    } else if (keyEvent == KeyEvent.VK_ADD &amp;&amp; e.isControlDown()) {</span>
<span class="nc" id="L732">      getAction(ActionW.ZOOM).ifPresent(a -&gt; a.setSliderValue(a.getSliderValue() + 1));</span>
<span class="nc bnc" id="L733" title="All 4 branches missed.">    } else if (keyEvent == KeyEvent.VK_ENTER &amp;&amp; e.isControlDown()) {</span>
<span class="nc" id="L734">      firePropertyChange(</span>
<span class="nc" id="L735">          ActionW.SYNCH.cmd(),</span>
          null,
<span class="nc" id="L737">          new SynchEvent(getSelectedViewPane(), ActionW.ZOOM.cmd(), -200.0));</span>
    } else {
<span class="nc" id="L739">      return false;</span>
    }
<span class="nc" id="L741">    return true;</span>
  }

  protected void triggerDrawingToolKeyEvent(int keyEvent, int modifiers) {
<span class="nc" id="L745">    triggerDrawActionKeyEvent(ActionW.DRAW_MEASURE, ActionW.MEASURE.cmd(), keyEvent, modifiers);</span>
<span class="nc" id="L746">    triggerDrawActionKeyEvent(ActionW.DRAW_GRAPHICS, ActionW.DRAW.cmd(), keyEvent, modifiers);</span>
<span class="nc" id="L747">  }</span>

  private void triggerDrawActionKeyEvent(
      Feature&lt;? extends ComboItemListener&lt;Graphic&gt;&gt; action,
      String cmd,
      int keyEvent,
      int modifiers) {
<span class="nc" id="L754">    Optional&lt;? extends ComboItemListener&lt;Graphic&gt;&gt; drawAction = getAction(action);</span>
<span class="nc bnc" id="L755" title="All 4 branches missed.">    if (drawAction.isPresent() &amp;&amp; drawAction.get().isActionEnabled()) {</span>
<span class="nc bnc" id="L756" title="All 2 branches missed.">      for (Object obj : drawAction.get().getAllItem()) {</span>
<span class="nc bnc" id="L757" title="All 2 branches missed.">        if (obj instanceof Graphic g) {</span>
<span class="nc bnc" id="L758" title="All 4 branches missed.">          if (g.getKeyCode() == keyEvent &amp;&amp; g.getModifier() == modifiers) {</span>
<span class="nc" id="L759">            ImageViewerPlugin&lt;E&gt; view = getSelectedView2dContainer();</span>
<span class="nc bnc" id="L760" title="All 2 branches missed.">            if (view != null) {</span>
<span class="nc" id="L761">              final ViewerToolBar&lt;?&gt; toolBar = view.getViewerToolBar();</span>
<span class="nc bnc" id="L762" title="All 4 branches missed.">              if (toolBar != null &amp;&amp; !toolBar.isCommandActive(cmd)) {</span>
<span class="nc" id="L763">                mouseActions.setAction(MouseActions.T_LEFT, cmd);</span>
<span class="nc" id="L764">                view.setMouseActions(mouseActions);</span>
<span class="nc" id="L765">                toolBar.changeButtonState(MouseActions.T_LEFT, cmd);</span>
              }
            }
<span class="nc" id="L768">            drawAction.get().setSelectedItem(obj);</span>
<span class="nc" id="L769">            return;</span>
          }
        }
      }
    }
<span class="nc" id="L774">  }</span>

  protected boolean isCompatible(MediaSeries&lt;E&gt; series, MediaSeries&lt;E&gt; series2) {
<span class="nc" id="L777">    return true;</span>
  }

  public void setSelectedView2dContainer(ImageViewerPlugin&lt;E&gt; selectedView2dContainer) {
<span class="nc bnc" id="L781" title="All 2 branches missed.">    if (this.selectedView2dContainer != null) {</span>
<span class="nc" id="L782">      this.selectedView2dContainer.setMouseActions(null);</span>
    }

<span class="nc" id="L785">    this.selectedView2dContainer = selectedView2dContainer;</span>
<span class="nc bnc" id="L786" title="All 2 branches missed.">    if (selectedView2dContainer != null) {</span>
<span class="nc" id="L787">      selectedView2dContainer.setMouseActions(mouseActions);</span>
    }
<span class="nc" id="L789">  }</span>

  public abstract void resetDisplay();

  public String resolvePlaceholders(String template) {
<span class="nc" id="L794">    return template;</span>
  }

  public void dicomExportAction(Launcher launcher) {
    // Do nothing
<span class="nc" id="L799">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>